{% extends "base.html" %}

{# ============================================================
   SAKİN ANA PANEL - 4 DİL (TR / EN / ME / RU) UYUMLU
   ============================================================ #}

{% set LANG = session.get('lang','tr') %}

{% set I18N_PAGE = {
  'tr': {
    'page_title': 'Sakin Ana Panel',
    'topbar_title': 'Sakin Ana Paneli',

    'card_remaining_title': 'Kalan Toplam Borç',
    'card_remaining_sub': 'Tüm faturalar - ödenenler',

    'card_paid_title': 'Toplam Ödenen',
    'card_paid_sub': 'Sisteme girilen tüm ödemeler',

    'card_gross_title': 'Toplam Borç (Brüt)',
    'card_gross_sub': 'Tüm fatura / aidat kalemleri toplamı',

    'card_count_title': 'Fatura / Aidat Sayısı',
    'card_count_sub_open': 'Açık',
    'card_count_sub_partial': 'Kısmi',
    'card_count_sub_paid': 'Ödenen',

    'last_bills_title': 'Son Faturalar / Aidatlar',
    'last_bills_total': 'Toplam',

    'th_type': 'Tür',
    'th_desc': 'Açıklama',
    'th_due': 'Vade',
    'th_amount': 'Tutar',
    'th_status': 'Durum',

    'view_all_debts': 'Tüm borçları görüntüle →',
    'empty_bills': 'Kayıtlı fatura / aidat bulunmuyor.',

    'last_payments_title': 'Son Ödemelerim',
    'last_payments_sub': 'Son 5 ödeme',
    'th_date': 'Tarih',
    'th_payment_amount': 'Tutar',
    'th_payment_type': 'Tür',
    'view_all_payments': 'Tüm ödemeleri görüntüle →',
    'empty_payments': 'Henüz ödeme kaydı bulunmuyor.',

    'announcements_title': 'Duyurular',
    'announcements_sub': 'Son 5 duyuru',
    'announcements_expired': '(Süresi doldu)',
    'empty_announcements': 'Henüz duyuru bulunmuyor.',

    'tickets_title': 'Son Taleplerim',
    'tickets_sub': 'Son 5 talep',
    'th_ticket_title': 'Başlık',
    'th_ticket_status': 'Durum',
    'th_ticket_date': 'Tarih',
    'view_all_tickets': 'Tüm talepleri görüntüle →',
    'empty_tickets': 'Henüz talep oluşturmadınız.',

    'status_open': 'Açık',
    'status_partial': 'Kısmi',
    'status_paid': 'Ödendi',

    'type_general': 'Genel',
    'dash': '-'
  },

  'en': {
    'page_title': 'Resident Dashboard',
    'topbar_title': 'Resident Dashboard',

    'card_remaining_title': 'Remaining Total Debt',
    'card_remaining_sub': 'All bills - paid amounts',

    'card_paid_title': 'Total Paid',
    'card_paid_sub': 'All payments recorded in the system',

    'card_gross_title': 'Total Debt (Gross)',
    'card_gross_sub': 'Total of all bill / dues items',

    'card_count_title': 'Bill / Dues Count',
    'card_count_sub_open': 'Open',
    'card_count_sub_partial': 'Partial',
    'card_count_sub_paid': 'Paid',

    'last_bills_title': 'Latest Bills / Dues',
    'last_bills_total': 'Total',

    'th_type': 'Type',
    'th_desc': 'Description',
    'th_due': 'Due',
    'th_amount': 'Amount',
    'th_status': 'Status',

    'view_all_debts': 'View all debts →',
    'empty_bills': 'No bill / dues records found.',

    'last_payments_title': 'My Latest Payments',
    'last_payments_sub': 'Last 5 payments',
    'th_date': 'Date',
    'th_payment_amount': 'Amount',
    'th_payment_type': 'Type',
    'view_all_payments': 'View all payments →',
    'empty_payments': 'No payment records yet.',

    'announcements_title': 'Announcements',
    'announcements_sub': 'Latest 5 announcements',
    'announcements_expired': '(Expired)',
    'empty_announcements': 'No announcements yet.',

    'tickets_title': 'My Latest Requests',
    'tickets_sub': 'Last 5 requests',
    'th_ticket_title': 'Title',
    'th_ticket_status': 'Status',
    'th_ticket_date': 'Date',
    'view_all_tickets': 'View all requests →',
    'empty_tickets': 'You have not created any request yet.',

    'status_open': 'Open',
    'status_partial': 'Partial',
    'status_paid': 'Paid',

    'type_general': 'General',
    'dash': '-'
  },

  'me': {
    'page_title': 'Panel stanara',
    'topbar_title': 'Glavni panel stanara',

    'card_remaining_title': 'Preostali ukupan dug',
    'card_remaining_sub': 'Svi računi - uplate',

    'card_paid_title': 'Ukupno uplaćeno',
    'card_paid_sub': 'Sve uplate unesene u sistem',

    'card_gross_title': 'Ukupan dug (bruto)',
    'card_gross_sub': 'Ukupno svih računa / članarina',

    'card_count_title': 'Broj računa / članarina',
    'card_count_sub_open': 'Otvoreno',
    'card_count_sub_partial': 'Djelimično',
    'card_count_sub_paid': 'Plaćeno',

    'last_bills_title': 'Posljednji računi / članarine',
    'last_bills_total': 'Ukupno',

    'th_type': 'Tip',
    'th_desc': 'Opis',
    'th_due': 'Rok',
    'th_amount': 'Iznos',
    'th_status': 'Status',

    'view_all_debts': 'Pogledaj sve dugove →',
    'empty_bills': 'Nema evidentiranih računa / članarina.',

    'last_payments_title': 'Moje posljednje uplate',
    'last_payments_sub': 'Posljednjih 5 uplata',
    'th_date': 'Datum',
    'th_payment_amount': 'Iznos',
    'th_payment_type': 'Tip',
    'view_all_payments': 'Pogledaj sve uplate →',
    'empty_payments': 'Još nema evidencije uplata.',

    'announcements_title': 'Obavještenja',
    'announcements_sub': 'Posljednjih 5 obavještenja',
    'announcements_expired': '(Isteklo)',
    'empty_announcements': 'Još nema obavještenja.',

    'tickets_title': 'Moji posljednji zahtjevi',
    'tickets_sub': 'Posljednjih 5 zahtjeva',
    'th_ticket_title': 'Naslov',
    'th_ticket_status': 'Status',
    'th_ticket_date': 'Datum',
    'view_all_tickets': 'Pogledaj sve zahtjeve →',
    'empty_tickets': 'Još nijeste kreirali zahtjev.',

    'status_open': 'Otvoreno',
    'status_partial': 'Djelimično',
    'status_paid': 'Plaćeno',

    'type_general': 'Opšte',
    'dash': '-'
  },

  'ru': {
    'page_title': 'Панель жильца',
    'topbar_title': 'Главная панель жильца',

    'card_remaining_title': 'Остаток общего долга',
    'card_remaining_sub': 'Все счета − оплаченные суммы',

    'card_paid_title': 'Всего оплачено',
    'card_paid_sub': 'Все платежи, внесённые в систему',

    'card_gross_title': 'Общий долг (брутто)',
    'card_gross_sub': 'Сумма всех начислений (счета / взносы)',

    'card_count_title': 'Количество счетов / взносов',
    'card_count_sub_open': 'Открыто',
    'card_count_sub_partial': 'Частично',
    'card_count_sub_paid': 'Оплачено',

    'last_bills_title': 'Последние счета / взносы',
    'last_bills_total': 'Итого',

    'th_type': 'Тип',
    'th_desc': 'Описание',
    'th_due': 'Срок',
    'th_amount': 'Сумма',
    'th_status': 'Статус',

    'view_all_debts': 'Посмотреть все долги →',
    'empty_bills': 'Начислений не найдено.',

    'last_payments_title': 'Мои последние платежи',
    'last_payments_sub': 'Последние 5 платежей',
    'th_date': 'Дата',
    'th_payment_amount': 'Сумма',
    'th_payment_type': 'Тип',
    'view_all_payments': 'Посмотреть все платежи →',
    'empty_payments': 'Платежей пока нет.',

    'announcements_title': 'Объявления',
    'announcements_sub': 'Последние 5 объявлений',
    'announcements_expired': '(Истекло)',
    'empty_announcements': 'Объявлений пока нет.',

    'tickets_title': 'Мои последние заявки',
    'tickets_sub': 'Последние 5 заявок',
    'th_ticket_title': 'Тема',
    'th_ticket_status': 'Статус',
    'th_ticket_date': 'Дата',
    'view_all_tickets': 'Посмотреть все заявки →',
    'empty_tickets': 'Вы ещё не создавали заявки.',

    'status_open': 'Открыто',
    'status_partial': 'Частично',
    'status_paid': 'Оплачено',

    'type_general': 'Общее',
    'dash': '-'
  }
} %}

{% macro tp(k) -%}
  {{ I18N_PAGE.get(LANG, I18N_PAGE['tr']).get(k, I18N_PAGE['tr'].get(k, k)) }}
{%- endmacro %}

{% block title %}{{ tp('page_title') }}{% endblock %}
{% block topbar_title %}
  {{ tp('topbar_title') }}
  {% if session.active_site_name %}
    – {{ session.active_site_name }}
  {% elif current_site_name %}
    – {{ current_site_name }}
  {% endif %}
{% endblock %}

{% block content %}

<style>
  .resident-dashboard-grid {
    display: grid;
    grid-template-columns: 2fr 1.5fr;
    gap: 16px;
    align-items: flex-start;
  }

  .resident-cards {
    display: grid;
    grid-template-columns: repeat(4, minmax(0, 1fr));
    gap: 12px;
  }

  .resident-card {
    background: #ffffff;
    border-radius: 14px;
    padding: 12px 14px;
    box-shadow: 0 10px 25px rgba(15, 23, 42, .05);
    border: 1px solid #e5e7eb;
  }

  .resident-card h3 {
    margin: 0;
    font-size: 13px;
    font-weight: 600;
    color: #6b7280;
  }

  .resident-card .value {
    margin-top: 6px;
    font-size: 20px;
    font-weight: 700;
    color: #111827;
  }

  .resident-card .sub {
    margin-top: 2px;
    font-size: 11px;
    color: #9ca3af;
  }

  .amount-positive { color: #16a34a; font-weight: 700; }
  .amount-negative { color: #b91c1c; font-weight: 700; }

  .status-pill {
    display: inline-flex;
    align-items: center;
    padding: 2px 8px;
    border-radius: 999px;
    font-size: 11px;
    font-weight: 500;
  }

  .status-open { background: #fef2f2; color: #b91c1c; }
  .status-partial { background: #fffbeb; color: #92400e; }
  .status-paid { background: #ecfdf3; color: #166534; }

  .section-card {
    background: #ffffff;
    border-radius: 14px;
    padding: 14px 16px;
    box-shadow: 0 10px 25px rgba(15, 23, 42, .05);
    border: 1px solid #e5e7eb;
  }

  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    margin-bottom: 8px;
  }

  .section-header h2 {
    margin: 0;
    font-size: 15px;
    font-weight: 600;
    color: #111827;
  }

  .section-header span {
    font-size: 11px;
    color: #9ca3af;
  }

  .list-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
  }

  .list-table th,
  .list-table td {
    padding: 6px 4px;
    text-align: left;
    border-bottom: 1px solid #f3f4f6;
    vertical-align: middle;
  }

  .list-table th {
    font-size: 11px;
    font-weight: 600;
    color: #6b7280;
  }

  .list-table tr:last-child td { border-bottom: none; }

  .pill-small {
    display: inline-flex;
    padding: 2px 8px;
    border-radius: 999px;
    font-size: 10px;
    background: #f3f4f6;
    color: #4b5563;
  }

  .announcement-item {
    padding: 6px 0;
    border-bottom: 1px solid #f3f4f6;
  }

  .announcement-item:last-child { border-bottom: none; }

  .announcement-item h4 {
    margin: 0 0 2px 0;
    font-size: 13px;
    font-weight: 600;
    color: #111827;
  }

  .announcement-item p {
    margin: 0;
    font-size: 11px;
    color: #6b7280;
  }

  .announcement-meta {
    margin-top: 2px;
    font-size: 10px;
    color: #9ca3af;
  }

  @media (max-width: 1024px) {
    .resident-dashboard-grid { grid-template-columns: 1fr; }
    .resident-cards { grid-template-columns: repeat(2, minmax(0, 1fr)); }
  }

  @media (max-width: 640px) {
    .resident-cards { grid-template-columns: 1fr; }
    .section-card { padding: 12px 12px; }
    .list-table th,
    .list-table td { padding: 5px 2px; }
  }
</style>

<div class="resident-dashboard-grid">

  <!-- SOL: ÖZET VE LİSTELER -->
  <section>

    <!-- Özet Kartlar -->
    <div class="resident-cards" style="margin-bottom: 14px;">

      <!-- Kalan Borç -->
      <div class="resident-card">
        <h3>{{ tp('card_remaining_title') }}</h3>
        <div class="value amount-negative">
          ₺{{ stats.total_open_amount | float | round(2) }}
        </div>
        <div class="sub">
          {{ tp('card_remaining_sub') }}
        </div>
      </div>

      <!-- Toplam Ödenen -->
      <div class="resident-card">
        <h3>{{ tp('card_paid_title') }}</h3>
        <div class="value amount-positive">
          ₺{{ stats.total_paid_amount | float | round(2) }}
        </div>
        <div class="sub">
          {{ tp('card_paid_sub') }}
        </div>
      </div>

      <!-- TOPLAM BORÇ: Tüm Fatura / Aidat Tutarı -->
      <div class="resident-card">
        <h3>{{ tp('card_gross_title') }}</h3>
        <div class="value">
          ₺{{ stats.total_bills_amount | float | round(2) }}
        </div>
        <div class="sub">
          {{ tp('card_gross_sub') }}
        </div>
      </div>

      <!-- Fatura Adedi -->
      <div class="resident-card">
        <h3>{{ tp('card_count_title') }}</h3>
        <div class="value">
          {{ stats.total_bills }}
        </div>
        <div class="sub">
          {{ tp('card_count_sub_open') }}: {{ stats.open_bills }}
          · {{ tp('card_count_sub_partial') }}: {{ stats.partial_bills }}
          · {{ tp('card_count_sub_paid') }}: {{ stats.paid_bills }}
        </div>
      </div>
    </div>

    <!-- Borç Listesi (Son faturalar) -->
    <div class="section-card" style="margin-bottom: 14px;">
      <div class="section-header">
        <h2>{{ tp('last_bills_title') }}</h2>
        <span>
          {{ tp('last_bills_total') }}: ₺{{ stats.total_bills_amount | float | round(2) }}
        </span>
      </div>

      {% if bills and bills|length > 0 %}
        <div style="overflow-x:auto;">
          <table class="list-table">
            <thead>
              <tr>
                <th>{{ tp('th_type') }}</th>
                <th>{{ tp('th_desc') }}</th>
                <th>{{ tp('th_due') }}</th>
                <th>{{ tp('th_amount') }}</th>
                <th>{{ tp('th_status') }}</th>
              </tr>
            </thead>
            <tbody>
              {% for bill in bills[:8] %}
                <tr>
                  <td>
                    <span class="pill-small">
                      {{ bill.type or tp('type_general') }}
                    </span>
                  </td>
                  <td>{{ bill.description or tp('dash') }}</td>
                  <td>
                    {% if bill.due_date %}
                      {{ bill.due_date.strftime("%d.%m.%Y") }}
                    {% else %}
                      {{ tp('dash') }}
                    {% endif %}
                  </td>
                  <td>₺{{ bill.amount | float | round(2) }}</td>
                  <td>
                    {% if bill.status == "open" %}
                      <span class="status-pill status-open">{{ tp('status_open') }}</span>
                    {% elif bill.status == "partial" %}
                      <span class="status-pill status-partial">{{ tp('status_partial') }}</span>
                    {% elif bill.status == "paid" %}
                      <span class="status-pill status-paid">{{ tp('status_paid') }}</span>
                    {% else %}
                      <span class="status-pill">{{ bill.status }}</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div style="margin-top: 6px; text-align:right;">
          <a href="{{ url_for('resident.borclarim') }}" style="font-size:11px; color:#2563eb; text-decoration:none;">
            {{ tp('view_all_debts') }}
          </a>
        </div>
      {% else %}
        <p style="font-size:12px; color:#6b7280; margin:0;">
          {{ tp('empty_bills') }}
        </p>
      {% endif %}
    </div>

    <!-- Ödemeler -->
    <div class="section-card">
      <div class="section-header">
        <h2>{{ tp('last_payments_title') }}</h2>
        <span>{{ tp('last_payments_sub') }}</span>
      </div>

      {% if payments and payments|length > 0 %}
        <div style="overflow-x:auto;">
          <table class="list-table">
            <thead>
              <tr>
                <th>{{ tp('th_date') }}</th>
                <th>{{ tp('th_payment_amount') }}</th>
                <th>{{ tp('th_payment_type') }}</th>
              </tr>
            </thead>
            <tbody>
              {% for p in payments %}
                <tr>
                  <td>
                    {% if p.payment_date %}
                      {{ p.payment_date.strftime("%d.%m.%Y") }}
                    {% else %}
                      {{ tp('dash') }}
                    {% endif %}
                  </td>
                  <td>₺{{ p.amount | float | round(2) }}</td>
                  <td>
                    {% if p.method %}
                      <span class="pill-small">{{ p.method }}</span>
                    {% else %}
                      {{ tp('dash') }}
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div style="margin-top: 6px; text-align:right;">
          <a href="{{ url_for('resident.odemelerim') }}" style="font-size:11px; color:#2563eb; text-decoration:none;">
            {{ tp('view_all_payments') }}
          </a>
        </div>
      {% else %}
        <p style="font-size:12px; color:#6b7280; margin:0;">
          {{ tp('empty_payments') }}
        </p>
      {% endif %}
    </div>

  </section>

  <!-- SAĞ: DUYURULAR + TALEPLER -->
  <aside style="display:flex; flex-direction:column; gap:14px;">

    <!-- Duyurular -->
    <div class="section-card">
      <div class="section-header">
        <h2>{{ tp('announcements_title') }}</h2>
        <span>{{ tp('announcements_sub') }}</span>
      </div>

      {% if announcements and announcements|length > 0 %}
        {% for ann in announcements %}
          {# 29 günden eskiyse "expired" gibi göster (mevcut mantığı bozmadan) #}
          {% set is_expired = ann.created_at and (today - ann.created_at.date()).days >= 29 %}

          <div class="announcement-item" style="{% if is_expired %}opacity:0.6;{% endif %}">
            <h4 style="{% if is_expired %}text-decoration:line-through;{% endif %}">{{ ann.title }}</h4>
            {% if ann.content %}
              <p style="{% if is_expired %}text-decoration:line-through;{% endif %}">{{ ann.content }}</p>
            {% endif %}
            <div class="announcement-meta">
              {{ ann.created_at.strftime("%d.%m.%Y %H:%M") }}
              {% if is_expired %}
                · <span style="font-style:italic;">{{ tp('announcements_expired') }}</span>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      {% else %}
        <p style="font-size:12px; color:#6b7280; margin:0;">
          {{ tp('empty_announcements') }}
        </p>
      {% endif %}
    </div>

    <!-- Talepler -->
    <div class="section-card">
      <div class="section-header">
        <h2>{{ tp('tickets_title') }}</h2>
        <span>{{ tp('tickets_sub') }}</span>
      </div>

      {% if tickets and tickets|length > 0 %}
        <div style="overflow-x:auto;">
          <table class="list-table">
            <thead>
              <tr>
                <th>{{ tp('th_ticket_title') }}</th>
                <th>{{ tp('th_ticket_status') }}</th>
                <th>{{ tp('th_ticket_date') }}</th>
              </tr>
            </thead>
            <tbody>
              {% for t in tickets %}
                <tr>
                  <td>{{ t.title }}</td>
                  <td>
                    <span class="pill-small">
                      {# burada istersek "open/closed" gibi backend değerlerini çevirip gösterebiliriz #}
                      {{ t.status or "open" }}
                    </span>
                  </td>
                  <td>
                    {% if t.created_at %}
                      {{ t.created_at.strftime("%d.%m.%Y %H:%M") }}
                    {% else %}
                      {{ tp('dash') }}
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div style="margin-top: 6px; text-align:right;">
          <a href="{{ url_for('resident.taleplerim') }}" style="font-size:11px; color:#2563eb; text-decoration:none;">
            {{ tp('view_all_tickets') }}
          </a>
        </div>
      {% else %}
        <p style="font-size:12px; color:#6b7280; margin:0;">
          {{ tp('empty_tickets') }}
        </p>
      {% endif %}
    </div>

  </aside>

</div>

{% endblock %}
