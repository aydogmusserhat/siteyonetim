<!doctype html>
<html lang="{{ session.get('lang','tr') }}">
<head>
  <meta charset="utf-8">
  <title>
    {% block title %}
    {{ 'Apartman Y√∂netim Paneli' if session.get('lang','tr')=='tr'
      else ('Apartment Management Panel' if session.get('lang')=='en'
      else ('–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–æ–º–æ–º' if session.get('lang')=='ru'
      else 'Panel upravljanja zgradom')) }}

    {% endblock %}
  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="{{ url_for('static', filename='css/app.css') }}">

  {% block head_extra %}{% endblock %}

  <style>
    /* Dil se√ßici (topbar saƒü) */
    .lang-switch {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .lang-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #fff;
      cursor: pointer;
      font-size: 12px;
      color: #111827;
      white-space: nowrap;
    }
    .lang-btn:active { transform: scale(0.99); }
    .lang-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: #111827;
      opacity: .15;
    }
    .lang-menu {
      position: absolute;
      right: 0;
      top: calc(100% + 8px);
      min-width: 170px;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,.08);
      padding: 6px;
      display: none;
      z-index: 9999;
    }
    .lang-menu.is-open { display: block; }
    .lang-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 10px;
      text-decoration: none;
      color: #111827;
      font-size: 12px;
    }
    .lang-item:hover { background: #f3f4f6; }
    .lang-code {
      font-size: 11px;
      color: #6b7280;
    }
    .lang-flag {
      display: inline-flex;
      width: 22px;
      height: 16px;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      border: 1px solid #e5e7eb;
      font-size: 11px;
      background: #fff;
    }
    @media (max-width: 520px) {
      .lang-menu { left: auto; right: 0; }
      .lang-btn { padding: 6px 8px; }
    }
  </style>
</head>

<body class="{% block body_class %}{% endblock %}">

{% set LANG = session.get('lang','tr') %}
{% set I18N = {
  'tr': {
    'panel_title': 'Y√∂netim Paneli',
    'admin_view': 'Y√∂netici g√∂r√ºn√ºm√º',
    'resident_view': 'Sakin g√∂r√ºn√ºm√º',
    'system_view': 'Apartman / Site y√∂netim sistemi',
    'menu_admin_dashboard': 'Y√∂netim Paneli',
    'menu_apartments': 'Daireler',
    'menu_users': 'Kullanƒ±cƒ±lar',
    'menu_bills': 'Bor√ß / Aidatlar',
    'menu_payments': '√ñdemeler',
    'menu_announcements': 'Duyurular',
    'menu_tickets': 'Talepler',
    'menu_settings': 'Ayarlar',
    'menu_site_mgmt': 'Site Y√∂netimi',
    'menu_resident_dashboard': 'Ana Panel',
    'menu_my_debts': 'Bor√ßlarƒ±m',
    'menu_my_payments': '√ñdemelerim',
    'menu_my_tickets': 'Taleplerim',
    'menu_profile': 'Profilim',
    'logout': '√áƒ±kƒ±≈ü Yap',
    'logged_in': 'Giri≈ü Yapƒ±ldƒ±',
    'role_admin': 'Y√∂netici',
    'role_resident': 'Sakin',
    'role_admin_of': 'Y√∂netici ‚Ä¢ ',
    'role_resident_of': 'Sakin ‚Ä¢ ',
    'open_close_menu': 'Men√ºy√º a√ß/kapa',
    'close_menu': 'Men√ºy√º kapat',
    'language': 'Dil',

    'default_brand_name': 'QR Site Y√∂netim',
    'default_site_name': 'Site / Apartman',

    'role_super_admin': 'Sistem S√ºper Y√∂neticisi',
    'all_sites_global': 'T√ºm Siteler (Genel)'
  },
  'en': {
    'panel_title': 'Management Panel',
    'admin_view': 'Admin view',
    'resident_view': 'Resident view',
    'system_view': 'Apartment / Site management system',
    'menu_admin_dashboard': 'Dashboard',
    'menu_apartments': 'Apartments',
    'menu_users': 'Users',
    'menu_bills': 'Dues / Bills',
    'menu_payments': 'Payments',
    'menu_announcements': 'Announcements',
    'menu_tickets': 'Requests',
    'menu_settings': 'Settings',
    'menu_site_mgmt': 'Site Management',
    'menu_resident_dashboard': 'Home',
    'menu_my_debts': 'My Debts',
    'menu_my_payments': 'My Payments',
    'menu_my_tickets': 'My Requests',
    'menu_profile': 'My Profile',
    'logout': 'Log out',
    'logged_in': 'Logged in',
    'role_admin': 'Admin',
    'role_resident': 'Resident',
    'role_admin_of': 'Admin ‚Ä¢ ',
    'role_resident_of': 'Resident ‚Ä¢ ',
    'open_close_menu': 'Open/close menu',
    'close_menu': 'Close menu',
    'language': 'Language',

    'default_brand_name': 'QR Site Management',
    'default_site_name': 'Site / Building',

    'role_super_admin': 'System Super Admin',
    'all_sites_global': 'All Sites (Global)'
  },
  'ru': {
    'panel_title': '–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è',
    'admin_view': '–†–µ–∂–∏–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞',
    'resident_view': '–†–µ–∂–∏–º –∂–∏–ª—å—Ü–∞',
    'system_view': '–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–æ–º–æ–º / –∫–æ–º–ø–ª–µ–∫—Å–æ–º',

    'menu_admin_dashboard': '–ü–∞–Ω–µ–ª—å',
    'menu_apartments': '–ö–≤–∞—Ä—Ç–∏—Ä—ã',
    'menu_users': '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏',
    'menu_bills': '–î–æ–ª–≥–∏ / –í–∑–Ω–æ—Å—ã',
    'menu_payments': '–ü–ª–∞—Ç–µ–∂–∏',
    'menu_announcements': '–û–±—ä—è–≤–ª–µ–Ω–∏—è',
    'menu_tickets': '–ó–∞—è–≤–∫–∏',
    'menu_settings': '–ù–∞—Å—Ç—Ä–æ–π–∫–∏',
    'menu_site_mgmt': '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∞–π—Ç–∞–º–∏',

    'menu_resident_dashboard': '–ì–ª–∞–≤–Ω–∞—è',
    'menu_my_debts': '–ú–æ–∏ –¥–æ–ª–≥–∏',
    'menu_my_payments': '–ú–æ–∏ –ø–ª–∞—Ç–µ–∂–∏',
    'menu_my_tickets': '–ú–æ–∏ –∑–∞—è–≤–∫–∏',
    'menu_profile': '–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å',

    'logout': '–í—ã–π—Ç–∏',
    'logged_in': '–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω',

    'role_admin': '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',
    'role_resident': '–ñ–∏–ª–µ—Ü',
    'role_admin_of': '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä ‚Ä¢ ',
    'role_resident_of': '–ñ–∏–ª–µ—Ü ‚Ä¢ ',

    'open_close_menu': '–û—Ç–∫—Ä—ã—Ç—å/–∑–∞–∫—Ä—ã—Ç—å –º–µ–Ω—é',
    'close_menu': '–ó–∞–∫—Ä—ã—Ç—å –º–µ–Ω—é',
    'language': '–Ø–∑—ã–∫',

    'default_brand_name': 'QR –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ',
    'default_site_name': '–î–æ–º / –ö–æ–º–ø–ª–µ–∫—Å',

    'role_super_admin': '–°—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–∏—Å—Ç–µ–º—ã',
    'all_sites_global': '–í—Å–µ —Å–∞–π—Ç—ã (–ì–ª–æ–±–∞–ª—å–Ω–æ)'
  },
  'me': {
    'panel_title': 'Upravljaƒçki panel',
    'admin_view': 'Prikaz administratora',
    'resident_view': 'Prikaz stanara',
    'system_view': 'Sistem upravljanja zgradom / naseljem',
    'menu_admin_dashboard': 'Kontrolna tabla',
    'menu_apartments': 'Stanovi',
    'menu_users': 'Korisnici',
    'menu_bills': 'Dugovanja / ƒålanarine',
    'menu_payments': 'Uplate',
    'menu_announcements': 'Obavje≈°tenja',
    'menu_tickets': 'Zahtjevi',
    'menu_settings': 'Pode≈°avanja',
    'menu_site_mgmt': 'Upravljanje naseljem',
    'menu_resident_dashboard': 'Poƒçetna',
    'menu_my_debts': 'Moja dugovanja',
    'menu_my_payments': 'Moje uplate',
    'menu_my_tickets': 'Moji zahtjevi',
    'menu_profile': 'Moj profil',
    'logout': 'Odjava',
    'logged_in': 'Prijavljeno',
    'role_admin': 'Administrator',
    'role_resident': 'Stanar',
    'role_admin_of': 'Administrator ‚Ä¢ ',
    'role_resident_of': 'Stanar ‚Ä¢ ',
    'open_close_menu': 'Otvori/zatvori meni',
    'close_menu': 'Zatvori meni',
    'language': 'Jezik',

    'default_brand_name': 'QR Upravljanje',
    'default_site_name': 'Naselje / Zgrada',

    'role_super_admin': 'Sistemski Super Admin',
    'all_sites_global': 'Svi sajtovi (Globalno)'
  }
} %}
{% macro t(k) -%}
  {{ I18N.get(LANG, I18N['tr']).get(k, I18N['tr'].get(k, k)) }}
{%- endmacro %}

<div class="layout">

  {# ===========================================
     SIDEBAR
     =========================================== #}
  <aside class="sidebar" id="sidebar">

    {% set _role = session.get("user_role") %}
    {% set _active_site = session.get("active_site_name") %}

    {% set site_name = session.get("active_site_name")
      or (current_site_name if current_site_name is defined and current_site_name else t('default_brand_name')) %}

    {# Global modda (super_admin + aktif site yok): ba≈ülƒ±ƒüƒ± √ßeviriyle bas #}
    {% if _role == "super_admin" and not _active_site %}
      {% set site_name = t('all_sites_global') %}
    {% endif %}

    <div class="sidebar__header">
      <div class="sidebar__logo-wrapper">

        <img
          src="{{ url_for('static', filename='logo1.png') }}"
          alt="Logo"
          class="sidebar__logo-img"
          style="width:220px; height:150px; object-fit:contain;"
        >

        <div class="sidebar__brand-block">
          <div class="sidebar__brand-title">
            {{ site_name }}
          </div>

          <div class="sidebar__brand-subtitle">
            {{ t('panel_title') }}
          </div>
        </div>

        {% if session.get("user_role") == "super_admin" %}
          <a href="{{ url_for('admin.manage_sites', lang=LANG) }}" class="sidebar__link">
            {{ t('menu_site_mgmt') }}
          </a>
        {% endif %}

      </div>

      <button class="sidebar__close-btn" id="sidebarCloseBtn" aria-label="{{ t('close_menu') }}">
        ‚úï
      </button>
    </div>

    <div class="sidebar__user">
      {% set user_name = session.get("user_name") %}
      {% set user_role = session.get("user_role") %}
      {% set active_site_name = session.get("active_site_name") %}

      {% set fallback_site_name = session.get("site_name", t('default_site_name')) %}
      {% if user_role == "super_admin" and not active_site_name %}
        {% set fallback_site_name = t('all_sites_global') %}
      {% endif %}

      <div class="sidebar__user-name">
        {% if user_name %}
          {{ user_name }}
        {% else %}
          {{ t('logged_in') }}
        {% endif %}
      </div>

      <div class="sidebar__user-role">
        {% if user_role == "admin" %}
          {{ t('role_admin_of') }} {{ active_site_name or fallback_site_name }}
        {% elif user_role == "resident" %}
          {{ t('role_resident_of') }} {{ active_site_name or fallback_site_name }}
        {% elif user_role == "super_admin" %}
          {{ t('role_super_admin') }} ‚Ä¢
          {% if active_site_name %}
            {{ active_site_name }}
          {% else %}
            {{ t('all_sites_global') }}
          {% endif %}
        {% else %}
          {{ active_site_name or fallback_site_name }}
        {% endif %}
      </div>
    </div>

    <nav class="sidebar__nav">
      {% set endpoint = request.endpoint or "" %}

      {% if user_role == "admin" %}

        <a href="{{ url_for('admin.dashboard', lang=LANG) }}"
           class="sidebar__link {% if endpoint == 'admin.dashboard' %}sidebar__link--active{% endif %}">
          üè† {{ t('menu_admin_dashboard') }}
        </a>

        <a href="{{ url_for('admin.manage_apartments', lang=LANG) }}"
           class="sidebar__link {% if endpoint == 'admin.manage_apartments' %}sidebar__link--active{% endif %}">
          üè¢ {{ t('menu_apartments') }}
        </a>

        <a href="{{ url_for('admin.manage_users', lang=LANG) }}"
           class="sidebar__link {% if endpoint == 'admin.manage_users' %}sidebar__link--active{% endif %}">
          üë• {{ t('menu_users') }}
        </a>

        <a href="{{ url_for('admin.manage_bills', lang=LANG) }}"
           class="sidebar__link {% if endpoint == 'admin.manage_bills' or endpoint == 'admin.dues_summary' %}sidebar__link--active{% endif %}">
          üí≥ {{ t('menu_bills') }}
        </a>

        <a href="{{ url_for('admin.manage_payments', lang=LANG) }}"
           class="sidebar__link {% if endpoint == 'admin.manage_payments' %}sidebar__link--active{% endif %}">
          üí∞ {{ t('menu_payments') }}
        </a>

        <a href="{{ url_for('admin.manage_announcements', lang=LANG) }}"
           class="sidebar__link {% if endpoint == 'admin.manage_announcements' %}sidebar__link--active{% endif %}">
          üì¢ {{ t('menu_announcements') }}
        </a>

        <a href="{{ url_for('admin.manage_tickets', lang=LANG) }}"
           class="sidebar__link {% if endpoint == 'admin.manage_tickets' %}sidebar__link--active{% endif %}">
          üõ† {{ t('menu_tickets') }}
        </a>

        <a href="{{ url_for('admin.settings', lang=LANG) }}"
           class="sidebar__link {% if endpoint == 'admin.settings' %}sidebar__link--active{% endif %}">
          ‚öôÔ∏è {{ t('menu_settings') }}
        </a>

      {% elif user_role == "resident" %}

        <a href="{{ url_for('resident.dashboard', lang=LANG) }}"
           class="sidebar__link {% if endpoint == 'resident.dashboard' %}sidebar__link--active{% endif %}">
          üè† {{ t('menu_resident_dashboard') }}
        </a>

        <a href="{{ url_for('resident.borclarim', lang=LANG) }}"
           class="sidebar__link {% if endpoint == 'resident.borclarim' %}sidebar__link--active{% endif %}">
          üí≥ {{ t('menu_my_debts') }}
        </a>

        <a href="{{ url_for('resident.odemelerim', lang=LANG) }}"
           class="sidebar__link {% if endpoint == 'resident.odemelerim' %}sidebar__link--active{% endif %}">
          üí∞ {{ t('menu_my_payments') }}
        </a>

        <a href="{{ url_for('resident.taleplerim', lang=LANG) }}"
           class="sidebar__link {% if endpoint == 'resident.taleplerim' %}sidebar__link--active{% endif %}">
          üõ† {{ t('menu_my_tickets') }}
        </a>

        <a href="{{ url_for('resident.profil', lang=LANG) }}"
           class="sidebar__link {% if endpoint == 'resident.profil' %}sidebar__link--active{% endif %}">
          üë§ {{ t('menu_profile') }}
        </a>

      {% else %}
        <a href="{{ url_for('admin.dashboard', lang=LANG) }}"
           class="sidebar__link {% if endpoint == 'admin.dashboard' %}sidebar__link--active{% endif %}">
          üè† {{ t('menu_admin_dashboard') }}
        </a>
      {% endif %}
    </nav>

    <div class="sidebar__footer">
      <a href="{{ url_for('auth.logout', lang=LANG) }}" class="sidebar__logout-btn">
        {{ t('logout') }}
      </a>
    </div>
  </aside>

  <div class="main">

    <header class="topbar">
      <button class="topbar__menu-btn" id="sidebarToggleBtn" aria-label="{{ t('open_close_menu') }}">
        ‚ò∞
      </button>

      <div>
        <div class="topbar__title">
          {% block topbar_title %}{{ t('panel_title') }}{% endblock %}
        </div>
        <div class="topbar__subtitle">
          {% if user_role == "admin" %}
            {{ t('admin_view') }}
          {% elif user_role == "resident" %}
            {{ t('resident_view') }}
          {% else %}
            {{ t('system_view') }}
          {% endif %}
        </div>
      </div>

      <div class="topbar__user" style="display:flex; align-items:center; gap:10px;">
        <div class="lang-switch" id="langSwitch">
          <button type="button" class="lang-btn" id="langBtn" aria-haspopup="true" aria-expanded="false">
            <span class="lang-dot"></span>
            <span style="font-weight:600;">{{ t('language') }}</span>
            <span style="color:#6b7280; font-size:11px;">({{ LANG|upper }})</span>
          </button>

          {% set nxt = request.full_path %}
          <div class="lang-menu" id="langMenu" role="menu" aria-label="Language menu">
            <a class="lang-item" role="menuitem" href="/set-lang/tr?next={{ nxt|urlencode }}">
              <span style="display:flex; align-items:center; gap:10px;">
                <span class="lang-flag">TR</span> T√ºrk√ße
              </span>
              <span class="lang-code">TR</span>
            </a>
            <a class="lang-item" role="menuitem" href="/set-lang/en?next={{ nxt|urlencode }}">
              <span style="display:flex; align-items:center; gap:10px;">
                <span class="lang-flag">EN</span> English
              </span>
              <span class="lang-code">EN</span>
            </a>
            <a class="lang-item" role="menuitem" href="/set-lang/me?next={{ nxt|urlencode }}">
              <span style="display:flex; align-items:center; gap:10px;">
                <span class="lang-flag">ME</span> Crnogorski
              </span>
              <span class="lang-code">ME</span>
            </a>
            <a class="lang-item" role="menuitem" href="/set-lang/ru?next={{ nxt|urlencode }}">
              <span style="display:flex; align-items:center; gap:10px;">
                <span class="lang-flag">RU</span> –†—É—Å—Å–∫–∏–π
              </span>
              <span class="lang-code">RU</span>
            </a>

          </div>
        </div>

        {% if user_name %}
          <span class="topbar__user-name">{{ user_name }}</span>
        {% endif %}
        {% if user_role %}
          <span class="topbar__user-role">
            {% if user_role == "admin" %}{{ t('role_admin') }}
            {% elif user_role == "resident" %}{{ t('role_resident') }}
            {% endif %}
          </span>
        {% endif %}
      </div>
    </header>

    <div class="flash-container" id="flashContainer">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            {% set flash_class = "flash" %}
            {% if category == "success" %}
              {% set flash_class = flash_class + " flash--success" %}
            {% elif category == "error" or category == "danger" %}
              {% set flash_class = flash_class + " flash--error" %}
            {% elif category == "info" %}
              {% set flash_class = flash_class + " flash--info" %}
            {% endif %}

            <div class="{{ flash_class }}">
              {{ message }}
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}
    </div>

    <main class="content">
      {% block content %}{% endblock %}
    </main>

  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.getElementById('sidebarToggleBtn');
    const closeBtn = document.getElementById('sidebarCloseBtn');
    const flashContainer = document.getElementById('flashContainer');

    if (toggleBtn && sidebar) {
      toggleBtn.addEventListener('click', function () {
        sidebar.classList.toggle('sidebar--open');
      });
    }

    if (closeBtn && sidebar) {
      closeBtn.addEventListener('click', function () {
        sidebar.classList.remove('sidebar--open');
      });
    }

    document.addEventListener('click', function (e) {
      if (!sidebar) return;
      if (!sidebar.classList.contains('sidebar--open')) return;

      const isClickInsideSidebar = sidebar.contains(e.target);
      const isClickOnToggle = toggleBtn && toggleBtn.contains(e.target);
      if (!isClickInsideSidebar && !isClickOnToggle) {
        sidebar.classList.remove('sidebar--open');
      }
    });

    if (flashContainer) {
      setTimeout(function () {
        flashContainer.style.transition = 'opacity 0.4s ease';
        flashContainer.style.opacity = '0';
        setTimeout(function () {
          if (flashContainer && flashContainer.parentNode) {
            flashContainer.parentNode.removeChild(flashContainer);
          }
        }, 450);
      }, 4000);
    }

    const langSwitch = document.getElementById('langSwitch');
    const langBtn = document.getElementById('langBtn');
    const langMenu = document.getElementById('langMenu');

    function closeLang() {
      if (!langMenu || !langBtn) return;
      langMenu.classList.remove('is-open');
      langBtn.setAttribute('aria-expanded', 'false');
    }
    function toggleLang() {
      if (!langMenu || !langBtn) return;
      const open = langMenu.classList.toggle('is-open');
      langBtn.setAttribute('aria-expanded', open ? 'true' : 'false');
    }

    if (langBtn && langMenu) {
      langBtn.addEventListener('click', function (e) {
        e.stopPropagation();
        toggleLang();
      });
      document.addEventListener('click', function (e) {
        if (!langSwitch) return;
        if (!langSwitch.contains(e.target)) closeLang();
      });
      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') closeLang();
      });
    }
  });
</script>

{% block body_extra %}{% endblock %}
</body>
</html>
