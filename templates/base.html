<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8">
  <title>{% block title %}Apartman YÃ¶netim Paneli{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="{{ url_for('static', filename='css/app.css') }}">

  {% block head_extra %}{% endblock %}
</head>
<body class="{% block body_class %}{% endblock %}">

<div class="layout">

  {# ===========================================
     SIDEBAR
     =========================================== #}
  <aside class="sidebar" id="sidebar">
{% set site_name = session.get("active_site_name")
    or (current_site_name if current_site_name is defined and current_site_name else 'QR Site YÃ¶netim') %}

<div class="sidebar__header">

  <div class="sidebar__logo-wrapper">

    <!-- LOGO (aynÄ± boyutta kalÄ±yor) -->
    <img
      src="{{ url_for('static', filename='logo1.png') }}"
      alt="Logo"
      class="sidebar__logo-img"
      style="width:220px; height:150px; object-fit:contain;"
    >

    <!-- ALTINA KURUMSAL SÄ°TE ADI -->
    <div class="sidebar__brand-block">
      <div class="sidebar__brand-title">
        {{ site_name }}
      </div>

      <div class="sidebar__brand-subtitle">
        YÃ¶netim Paneli
      </div>
    </div>
      {% if session.get("user_role") == "super_admin" %}
        <a href="{{ url_for('admin.manage_sites') }}" class="sidebar__link">
          Site YÃ¶netimi
        </a>
      {% endif %}

  </div>

  <!-- sadece mobilde gÃ¶rÃ¼nen buton -->
  <button class="sidebar__close-btn" id="sidebarCloseBtn" aria-label="MenÃ¼yÃ¼ kapat">
    âœ•
  </button>

</div>


    {# KullanÄ±cÄ± / Site bilgisi kutusu #}
    <div class="sidebar__user">
      {% set user_name = session.get("user_name") %}
      {% set user_role = session.get("user_role") %}
      {% set site_name = session.get("active_site_name") or session.get("site_name", "Site / Apartman") %}

      <div class="sidebar__user-name">
        {% if user_name %}
          {{ user_name }}
        {% else %}
          GiriÅŸ YapÄ±ldÄ±
        {% endif %}
      </div>
      <div class="sidebar__user-role">
        {% if user_role == "admin" %}
          YÃ¶netici â€¢ {{ site_name }}
        {% elif user_role == "resident" %}
          Sakin â€¢ {{ site_name }}
        {% else %}
          {{ site_name }}
        {% endif %}
      </div>
    </div>

    {# ===========================================
       NAV MENÃœ
       Admin / Sakin iÃ§in ayrÄ± gÃ¶ster
       =========================================== #}
    <nav class="sidebar__nav">
      {% set endpoint = request.endpoint or "" %}

      {% if user_role == "admin" %}

        <a href="{{ url_for('admin.dashboard') }}"
           class="sidebar__link {% if endpoint == 'admin.dashboard' %}sidebar__link--active{% endif %}">
          ğŸ  YÃ¶netim Paneli
        </a>

        <a href="{{ url_for('admin.manage_apartments') }}"
           class="sidebar__link {% if endpoint == 'admin.manage_apartments' %}sidebar__link--active{% endif %}">
          ğŸ¢ Daireler
        </a>

        <a href="{{ url_for('admin.manage_users') }}"
           class="sidebar__link {% if endpoint == 'admin.manage_users' %}sidebar__link--active{% endif %}">
          ğŸ‘¥ KullanÄ±cÄ±lar
        </a>

        <a href="{{ url_for('admin.manage_bills') }}"
           class="sidebar__link {% if endpoint == 'admin.manage_bills' or endpoint == 'admin.dues_summary' %}sidebar__link--active{% endif %}">
          ğŸ’³ BorÃ§ / Aidatlar
        </a>

        <a href="{{ url_for('admin.manage_payments') }}"
           class="sidebar__link {% if endpoint == 'admin.manage_payments' %}sidebar__link--active{% endif %}">
          ğŸ’° Ã–demeler
        </a>

        <a href="{{ url_for('admin.manage_announcements') }}"
           class="sidebar__link {% if endpoint == 'admin.manage_announcements' %}sidebar__link--active{% endif %}">
          ğŸ“¢ Duyurular
        </a>

        <a href="{{ url_for('admin.manage_tickets') }}"
           class="sidebar__link {% if endpoint == 'admin.manage_tickets' %}sidebar__link--active{% endif %}">
          ğŸ›  Talepler
        </a>

        <a href="{{ url_for('admin.settings') }}"
           class="sidebar__link {% if endpoint == 'admin.settings' %}sidebar__link--active{% endif %}">
          âš™ï¸ Ayarlar
        </a>

      {% elif user_role == "resident" %}

        <a href="{{ url_for('resident.dashboard') }}"
           class="sidebar__link {% if endpoint == 'resident.dashboard' %}sidebar__link--active{% endif %}">
          ğŸ  Ana Panel
        </a>

        <a href="{{ url_for('resident.borclarim') }}"
           class="sidebar__link {% if endpoint == 'resident.borclarim' %}sidebar__link--active{% endif %}">
          ğŸ’³ BorÃ§larÄ±m
        </a>

        <a href="{{ url_for('resident.odemelerim') }}"
           class="sidebar__link {% if endpoint == 'resident.odemelerim' %}sidebar__link--active{% endif %}">
          ğŸ’° Ã–demelerim
        </a>

        <a href="{{ url_for('resident.taleplerim') }}"
           class="sidebar__link {% if endpoint == 'resident.taleplerim' %}sidebar__link--active{% endif %}">
          ğŸ›  Taleplerim
        </a>

        <a href="{{ url_for('resident.profil') }}"
           class="sidebar__link {% if endpoint == 'resident.profil' %}sidebar__link--active{% endif %}">
          ğŸ‘¤ Profilim
        </a>

      {% else %}
        {# Rol yoksa minimum menÃ¼ (gÃ¼venlik iÃ§in) #}
        <a href="{{ url_for('admin.dashboard') }}"
           class="sidebar__link {% if endpoint == 'admin.dashboard' %}sidebar__link--active{% endif %}">
          ğŸ  Panel
        </a>
      {% endif %}
    </nav>

    <div class="sidebar__footer">
      <a href="{{ url_for('auth.logout') }}" class="sidebar__logout-btn">
        Ã‡Ä±kÄ±ÅŸ Yap
      </a>
    </div>
  </aside>

  {# ===========================================
     ANA ALAN (TOPBAR + CONTENT)
     =========================================== #}
  <div class="main">

    {# TOPBAR #}
    <header class="topbar">
      <button class="topbar__menu-btn" id="sidebarToggleBtn" aria-label="MenÃ¼yÃ¼ aÃ§/kapa">
        â˜°
      </button>

      <div>
        <div class="topbar__title">
          {% block topbar_title %}YÃ¶netim Paneli{% endblock %}
        </div>
        <div class="topbar__subtitle">
          {% if user_role == "admin" %}
            YÃ¶netici gÃ¶rÃ¼nÃ¼mÃ¼
          {% elif user_role == "resident" %}
            Sakin gÃ¶rÃ¼nÃ¼mÃ¼
          {% else %}
            Apartman / Site yÃ¶netim sistemi
          {% endif %}
        </div>
      </div>

      <div class="topbar__user">
        {% if user_name %}
          <span class="topbar__user-name">{{ user_name }}</span>
        {% endif %}
        {% if user_role %}
          <span class="topbar__user-role">
            {% if user_role == "admin" %}YÃ¶netici{% elif user_role == "resident" %}Sakin{% endif %}
          </span>
        {% endif %}
      </div>
    </header>

    {# FLASH MESAJLARI #}
    <div class="flash-container" id="flashContainer">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            {% set flash_class = "flash" %}
            {% if category == "success" %}
              {% set flash_class = flash_class + " flash--success" %}
            {% elif category == "error" or category == "danger" %}
              {% set flash_class = flash_class + " flash--error" %}
            {% elif category == "info" %}
              {% set flash_class = flash_class + " flash--info" %}
            {% endif %}

            <div class="{{ flash_class }}">
              {{ message }}
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}
    </div>

    {# SAYFA Ä°Ã‡ERÄ°ÄÄ° #}
    <main class="content">
      {% block content %}{% endblock %}
    </main>

  </div>
</div>

{# ===========================================
   GENEL JS (sidebar toggle + flash auto-hide)
   =========================================== #}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.getElementById('sidebarToggleBtn');
    const closeBtn = document.getElementById('sidebarCloseBtn');
    const flashContainer = document.getElementById('flashContainer');

    // Mobil menÃ¼ aÃ§/kapa
    if (toggleBtn && sidebar) {
      toggleBtn.addEventListener('click', function () {
        sidebar.classList.toggle('sidebar--open');
      });
    }

    if (closeBtn && sidebar) {
      closeBtn.addEventListener('click', function () {
        sidebar.classList.remove('sidebar--open');
      });
    }

    // Sidebar aÃ§Ä±kken dÄ±ÅŸarÄ± tÄ±klayÄ±nca kapatma (mobil)
    document.addEventListener('click', function (e) {
      if (!sidebar) return;
      if (!sidebar.classList.contains('sidebar--open')) return;

      const isClickInsideSidebar = sidebar.contains(e.target);
      const isClickOnToggle = toggleBtn && toggleBtn.contains(e.target);
      if (!isClickInsideSidebar && !isClickOnToggle) {
        sidebar.classList.remove('sidebar--open');
      }
    });

    // Flash mesajlarÄ± otomatik gizle
    if (flashContainer) {
      setTimeout(function () {
        flashContainer.style.transition = 'opacity 0.4s ease';
        flashContainer.style.opacity = '0';
        setTimeout(function () {
          if (flashContainer && flashContainer.parentNode) {
            flashContainer.parentNode.removeChild(flashContainer);
          }
        }, 450);
      }, 4000);
    }
  });
</script>

{% block body_extra %}{% endblock %}
</body>
</html>
