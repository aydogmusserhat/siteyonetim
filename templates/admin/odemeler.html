{% extends "base.html" %}

{# ============================================================
   √ñDEME Y√ñNETƒ∞Mƒ∞ - GELƒ∞≈ûTƒ∞Rƒ∞LMƒ∞≈û (TR / EN / ME / RU) UYUMLU
   - Daire se√ß -> √∂denmemi≈ü bor√ßlar listelenir
   - Bor√ß se√ß -> kalan/√∂denen/toplam g√∂r√ºn√ºr + √∂deme √∂zeti
   - Kaydet -> mevcut backend /admin/payments POST'u ile uyumlu
   ============================================================ #}

{% set LANG = session.get('lang','tr') %}

{% set I18N_PAGE = {
  'tr': {
    'page_title': '√ñdeme Y√∂netimi',
    'topbar_title': '√ñdeme Y√∂netimi',

    'new_payment_title': 'Yeni √ñdeme Kaydƒ±',
    'label_apartment': 'Daire',
    'apartment_pick': 'Daire se√ßin...',

    'label_unpaid_bills': '√ñdenmemi≈ü Bor√ßlar',
    'unpaid_hint': 'Daire se√ßerek bor√ßlarƒ± y√ºkleyin',
    'no_unpaid': 'Bu dairenin √∂denmemi≈ü borcu yok',

    'selected_bill_title': 'Se√ßili Bor√ß Detaylarƒ±',
    'bill_desc': 'A√ßƒ±klama',
    'bill_total': 'Toplam Tutar',
    'bill_paid': 'Daha √ñnce √ñdenen',
    'bill_remaining': 'Kalan Tutar',

    'label_amount': '√ñdeme Tutarƒ± (‚Ç∫)',
    'label_payment_date': '√ñdeme Tarihi',
    'label_method': '√ñdeme Y√∂ntemi',
    'method_none': 'Se√ßilmedi',
    'method_cash': 'Nakit',
    'method_bank': 'Banka Havalesi / EFT',
    'method_pos': 'POS / Kredi Kartƒ±',
    'method_online': 'Online √ñdeme',

    'label_payer': '√ñdemeyi Yapan (Opsiyonel)',
    'payer_unknown': 'Belirtilmedi',

    'payment_summary': '√ñdeme √ñzeti',
    'summary_pay': 'Yapƒ±lacak √ñdeme',
    'summary_new_remaining': 'Yeni Kalan',
    'summary_status': 'Durum',
    'status_open': 'A√áIK',
    'status_partial': 'KISMƒ∞',
    'status_paid': '√ñDENDƒ∞',

    'btn_save_payment': '√ñdemeyi Kaydet',

    'list_title': '√ñdeme Tarih√ßesi',
    'col_apartment': 'Daire',
    'col_related': 'Bor√ß T√ºr√º',
    'col_amount': 'Tutar',
    'col_date': 'Tarih',
    'col_method': 'Y√∂ntem',
    'col_receipt': 'Makbuz',
    'col_actions': 'ƒ∞≈ülem',
    'btn_delete': 'Sil',
    'confirm_delete': 'Bu √∂demeyi silmek istiyor musunuz?',
    'delete_ok': '√ñdeme silindi.',
    'delete_fail': '√ñdeme silinemedi.' ,
    'col_receipt': 'Makbuz',
    'col_actions': 'ƒ∞≈ülem',
    'btn_delete': 'Sil',
    'confirm_delete': 'Bu √∂demeyi silmek istiyor musunuz?',
    'delete_ok': '√ñdeme silindi.',
    'delete_fail': '√ñdeme silinemedi.' ,
    'empty': 'Hen√ºz √∂deme kaydƒ± yok',

    'err_apartment': 'Daire se√ßmelisiniz.',
    'err_bill': 'Bor√ß se√ßmelisiniz.',
    'err_amount': 'Ge√ßerli bir tutar girin.',
    'err_date': '√ñdeme tarihini se√ßmelisiniz.',
    'err_max': 'Bu bor√ß i√ßin maksimum √∂deme: '
  },

  'en': {
    'page_title': 'Payment Management',
    'topbar_title': 'Payment Management',

    'new_payment_title': 'New Payment Record',
    'label_apartment': 'Apartment',
    'apartment_pick': 'Select an apartment...',

    'label_unpaid_bills': 'Unpaid Debts',
    'unpaid_hint': 'Select an apartment to load debts',
    'no_unpaid': 'No unpaid debts for this apartment',

    'selected_bill_title': 'Selected Debt Details',
    'bill_desc': 'Description',
    'bill_total': 'Total',
    'bill_paid': 'Already Paid',
    'bill_remaining': 'Remaining',

    'label_amount': 'Payment Amount (‚Ç∫)',
    'label_payment_date': 'Payment Date',
    'label_method': 'Payment Method',
    'method_none': 'Not selected',
    'method_cash': 'Cash',
    'method_bank': 'Bank Transfer / EFT',
    'method_pos': 'POS / Credit Card',
    'method_online': 'Online Payment',

    'label_payer': 'Paid By (optional)',
    'payer_unknown': 'Not specified',

    'payment_summary': 'Payment Summary',
    'summary_pay': 'Payment',
    'summary_new_remaining': 'New Remaining',
    'summary_status': 'Status',
    'status_open': 'OPEN',
    'status_partial': 'PARTIAL',
    'status_paid': 'PAID',

    'btn_save_payment': 'Save Payment',

    'list_title': 'Payment History',
    'col_apartment': 'Apartment',
    'col_related': 'Debt Type',
    'col_amount': 'Amount',
    'col_date': 'Date',
    'col_method': 'Method',
    'col_receipt': 'Receipt',
    'col_actions': 'Action',
    'btn_delete': 'Delete',
    'confirm_delete': 'Do you want to delete this payment?',
    'delete_ok': 'Payment deleted.',
    'delete_fail': 'Could not delete payment.' ,
    'col_receipt': 'Receipt',
    'col_actions': 'Action',
    'btn_delete': 'Delete',
    'confirm_delete': 'Do you want to delete this payment?',
    'delete_ok': 'Payment deleted.',
    'delete_fail': 'Could not delete payment.' ,
    'empty': 'No payments yet',

    'err_apartment': 'You must select an apartment.',
    'err_bill': 'You must select a debt.',
    'err_amount': 'Enter a valid amount.',
    'err_date': 'Select a payment date.',
    'err_max': 'Maximum for this debt: '
  },

  'me': {
    'page_title': 'Upravljanje uplatama',
    'topbar_title': 'Upravljanje uplatama',

    'new_payment_title': 'Nova uplata',
    'label_apartment': 'Stan',
    'apartment_pick': 'Izaberite stan...',

    'label_unpaid_bills': 'Neplaƒáeni dugovi',
    'unpaid_hint': 'Izaberite stan da uƒçitate dugove',
    'no_unpaid': 'Nema neplaƒáenih dugova za ovaj stan',

    'selected_bill_title': 'Detalji izabranog duga',
    'bill_desc': 'Opis',
    'bill_total': 'Ukupno',
    'bill_paid': 'Veƒá plaƒáeno',
    'bill_remaining': 'Preostalo',

    'label_amount': 'Iznos uplate (‚Ç∫)',
    'label_payment_date': 'Datum uplate',
    'label_method': 'Naƒçin plaƒáanja',
    'method_none': 'Nije izabrano',
    'method_cash': 'Gotovina',
    'method_bank': 'Bankovni transfer / EFT',
    'method_pos': 'POS / Kreditna kartica',
    'method_online': 'Online plaƒáanje',

    'label_payer': 'Uplatio/la (opciono)',
    'payer_unknown': 'Nije navedeno',

    'payment_summary': 'Sa≈æetak uplate',
    'summary_pay': 'Uplata',
    'summary_new_remaining': 'Novo preostalo',
    'summary_status': 'Status',
    'status_open': 'OTVORENO',
    'status_partial': 'DJELOMIƒåNO',
    'status_paid': 'PLAƒÜENO',

    'btn_save_payment': 'Saƒçuvaj uplatu',

    'list_title': 'Istorija uplata',
    'col_apartment': 'Stan',
    'col_related': 'Vrsta duga',
    'col_amount': 'Iznos',
    'col_date': 'Datum',
    'col_method': 'Naƒçin',
    'col_receipt': 'Raƒçun',
    'col_receipt': 'Potvrda',
    'col_actions': 'Akcija',
    'btn_delete': 'Obri≈°i',
    'confirm_delete': '≈Ωelite li obrisati ovu uplatu?',
    'delete_ok': 'Uplata obrisana.',
    'delete_fail': 'Uplata se ne mo≈æe obrisati.' ,
    'empty': 'Jo≈° nema uplata',

    'err_apartment': 'Morate izabrati stan.',
    'err_bill': 'Morate izabrati dug.',
    'err_amount': 'Unesite ispravan iznos.',
    'err_date': 'Izaberite datum uplate.',
    'err_max': 'Maksimum za ovaj dug: '
  },

  'ru': {
    'page_title': '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞–º–∏',
    'topbar_title': '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞–º–∏',

    'new_payment_title': '–ù–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂',
    'label_apartment': '–ö–≤–∞—Ä—Ç–∏—Ä–∞',
    'apartment_pick': '–í—ã–±–µ—Ä–∏—Ç–µ –∫–≤–∞—Ä—Ç–∏—Ä—É...',

    'label_unpaid_bills': '–ù–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ –¥–æ–ª–≥–∏',
    'unpaid_hint': '–í—ã–±–µ—Ä–∏—Ç–µ –∫–≤–∞—Ä—Ç–∏—Ä—É, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–ª–≥–∏',
    'no_unpaid': '–ù–µ—Ç –Ω–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã—Ö –¥–æ–ª–≥–æ–≤ –¥–ª—è —ç—Ç–æ–π –∫–≤–∞—Ä—Ç–∏—Ä—ã',

    'selected_bill_title': '–î–µ—Ç–∞–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –¥–æ–ª–≥–∞',
    'bill_desc': '–û–ø–∏—Å–∞–Ω–∏–µ',
    'bill_total': '–°—É–º–º–∞',
    'bill_paid': '–û–ø–ª–∞—á–µ–Ω–æ —Ä–∞–Ω–µ–µ',
    'bill_remaining': '–û—Å—Ç–∞—Ç–æ–∫',

    'label_amount': '–°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞ (‚Ç∫)',
    'label_payment_date': '–î–∞—Ç–∞ –ø–ª–∞—Ç–µ–∂–∞',
    'label_method': '–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã',
    'method_none': '–ù–µ –≤—ã–±—Ä–∞–Ω–æ',
    'method_cash': '–ù–∞–ª–∏—á–Ω—ã–µ',
    'method_bank': '–ë–∞–Ω–∫–æ–≤—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥ / EFT',
    'method_pos': 'POS / –ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞',
    'method_online': '–û–Ω–ª–∞–π–Ω –æ–ø–ª–∞—Ç–∞',

    'label_payer': '–ü–ª–∞—Ç–µ–ª—å—â–∏–∫ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)',
    'payer_unknown': '–ù–µ —É–∫–∞–∑–∞–Ω–æ',

    'payment_summary': '–°–≤–æ–¥–∫–∞ –ø–ª–∞—Ç–µ–∂–∞',
    'summary_pay': '–ü–ª–∞—Ç–µ–∂',
    'summary_new_remaining': '–ù–æ–≤—ã–π –æ—Å—Ç–∞—Ç–æ–∫',
    'summary_status': '–°—Ç–∞—Ç—É—Å',
    'status_open': '–û–¢–ö–†–´–¢–û',
    'status_partial': '–ß–ê–°–¢–ò–ß–ù–û',
    'status_paid': '–û–ü–õ–ê–ß–ï–ù–û',

    'btn_save_payment': '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å',

    'list_title': '–ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π',
    'col_apartment': '–ö–≤–∞—Ä—Ç–∏—Ä–∞',
    'col_related': '–¢–∏–ø –¥–æ–ª–≥–∞',
    'col_amount': '–°—É–º–º–∞',
    'col_date': '–î–∞—Ç–∞',
    'col_method': '–°–ø–æ—Å–æ–±',
    'col_receipt': '–ö–≤–∏—Ç–∞–Ω—Ü–∏—è',
    'col_actions': '–î–µ–π—Å—Ç–≤–∏–µ',
    'btn_delete': '–£–¥–∞–ª–∏—Ç—å',
    'confirm_delete': '–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–ª–∞—Ç–µ–∂?',
    'delete_ok': '–ü–ª–∞—Ç—ë–∂ —É–¥–∞–ª—ë–Ω.',
    'delete_fail': '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø–ª–∞—Ç—ë–∂.' ,
    'col_receipt': '–ö–≤–∏—Ç–∞–Ω—Ü–∏—è',
    'col_actions': '–î–µ–π—Å—Ç–≤–∏–µ',
    'btn_delete': '–£–¥–∞–ª–∏—Ç—å',
    'confirm_delete': '–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–ª–∞—Ç–µ–∂?',
    'delete_ok': '–ü–ª–∞—Ç—ë–∂ —É–¥–∞–ª—ë–Ω.',
    'delete_fail': '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø–ª–∞—Ç—ë–∂.' ,
    'empty': '–ü–ª–∞—Ç–µ–∂–µ–π –ø–æ–∫–∞ –Ω–µ—Ç',

    'err_apartment': '–í—ã–±–µ—Ä–∏—Ç–µ –∫–≤–∞—Ä—Ç–∏—Ä—É.',
    'err_bill': '–í—ã–±–µ—Ä–∏—Ç–µ –¥–æ–ª–≥.',
    'err_amount': '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É.',
    'err_date': '–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –ø–ª–∞—Ç–µ–∂–∞.',
    'err_max': '–ú–∞–∫—Å–∏–º—É–º –¥–ª—è —ç—Ç–æ–≥–æ –¥–æ–ª–≥–∞: '
  }
} %}

{% set T = I18N_PAGE.get(LANG, I18N_PAGE['tr']) %}
{% macro tp(k) %}{{ T.get(k, k) }}{% endmacro %}

{% block title %}{{ tp('page_title') }}{% endblock %}
{% block topbar_title %}{{ tp('topbar_title') }}{% endblock %}

{% block content %}

<style>
  * { margin:0; padding:0; box-sizing:border-box; }

  .pay-body {
    font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
    background:#f5f7fa;
    padding: 10px 0;
  }

  .container {
    max-width: 1400px;
    margin: 0 auto;
    display:grid;
    grid-template-columns: 0.5fr 1fr;
    gap: 20px;
    padding: 0 14px;
  }

  @media (max-width: 1024px){
    .container{
      grid-template-columns: 1fr;
      gap: 14px;
      padding: 0 12px;
    }
    .card{
      padding: 16px;
      border-radius: 12px;
    }
  }

  @media (max-width: 420px){
    .container{ padding: 0 10px; }
    .card{ padding: 14px; }
  }

  .card {
    background:#fff;
    border-radius:12px;
    padding:24px;
    box-shadow:0 1px 3px rgba(0,0,0,0.1);
    width: 100%;
    min-width: 0;
  }

  .card h2 {
    font-size:18px;
    margin-bottom: 16px;
    color:#0f172a;
  }

  .form-group { margin-bottom: 16px; }

  label {
    display:block;
    font-size:13px;
    font-weight:600;
    margin-bottom:6px;
    color:#374151;
    text-transform:uppercase;
    letter-spacing:.5px;
  }

  select, input {
    width: 100%;
    padding:10px 12px;
    border:1px solid #e5e7eb;
    border-radius:8px;
    font-size:14px;
    transition:all .2s;
    background:#fff;
    min-width: 0;
  }

  select:focus, input:focus {
    outline:none;
    border-color:#3b82f6;
    box-shadow:0 0 0 3px rgba(59,130,246,0.12);
  }

  .grid-2 {
    display:grid;
    grid-template-columns: repeat(2, minmax(0,1fr));
    gap: 16px;
  }

  @media (max-width: 520px){
    .grid-2{ grid-template-columns: 1fr; gap: 12px; }
  }

  .bills-container {
    background:#f9fafb;
    border:1px solid #e5e7eb;
    border-radius:8px;
    padding:12px;
    max-height:250px;
    overflow:auto;
    margin-bottom: 16px;
  }

  @media (max-width: 520px){
    .bills-container{
      max-height: 320px;
      padding: 10px;
    }
  }

  .bill-item {
    padding:12px;
    background:#fff;
    border:1px solid #e5e7eb;
    border-radius:6px;
    margin-bottom:8px;
    cursor:pointer;
    transition:all .2s;
    min-width: 0;
  }

  .bill-item:hover {
    border-color:#3b82f6;
    box-shadow:0 2px 4px rgba(59,130,246,0.10);
  }

  .bill-item.selected {
    background:#eff6ff;
    border-color:#3b82f6;
    box-shadow:0 0 0 3px rgba(59,130,246,0.12);
  }

  .bill-header {
    font-weight:600;
    color:#0f172a;
    margin-bottom:4px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    flex-wrap: wrap;
  }

  .bill-info {
    font-size:12px;
    color:#6b7280;
    margin-bottom:6px;
    line-height: 1.35;
    word-break: break-word;
  }

  .bill-amounts {
    display:grid;
    grid-template-columns: repeat(3, minmax(0,1fr));
    gap:8px;
    font-size:12px;
    border-top:1px solid #e5e7eb;
    padding-top:8px;
    margin-top:8px;
  }

  @media (max-width: 520px){
    .bill-amounts{ grid-template-columns: 1fr; gap: 10px; }
    .amount-box{ display:flex; justify-content:space-between; align-items:center; text-align:left; }
    .amount-label{ margin-bottom:0; }
  }

  .amount-box { text-align:center; }
  .amount-label {
    color:#6b7280;
    font-size:10px;
    text-transform:uppercase;
    letter-spacing:.3px;
    margin-bottom:3px;
  }
  .amount-value {
    font-weight:700;
    color:#0f172a;
    font-size:13px;
  }
  .remaining-amount { color:#dc2626; font-weight:700; }
  .paid-amount { color:#16a34a; }

  .status-badge {
    display:inline-block;
    padding:4px 8px;
    border-radius:4px;
    font-size:11px;
    font-weight:700;
    text-transform:uppercase;
    white-space: nowrap;
  }
  .status-open { background:#fee2e2; color:#991b1b; }
  .status-partial { background:#fef3c7; color:#92400e; }
  .status-paid { background:#dcfce7; color:#166534; }

  .divider { height:1px; background:#e5e7eb; margin: 16px 0; }

  .info-box {
    background:#eff6ff;
    border:1px solid #bfdbfe;
    border-radius:8px;
    padding:12px;
    margin-bottom:16px;
    font-size:13px;
    color:#1e40af;
  }
  .info-box strong { color:#0f172a; }

  .summary-grid {
    display:grid;
    grid-template-columns: repeat(3, minmax(0,1fr));
    gap: 12px;
    margin-bottom: 4px;
  }

  @media (max-width: 520px){
    .summary-grid{ grid-template-columns: 1fr; }
  }

  .summary-card {
    background:#f9fafb;
    padding:12px;
    border-radius:8px;
    border:1px solid #e5e7eb;
    text-align:center;
  }
  .summary-label {
    font-size:11px;
    color:#6b7280;
    text-transform:uppercase;
    letter-spacing:.3px;
    margin-bottom:4px;
  }
  .summary-value {
    font-size:18px;
    font-weight:800;
    color:#0f172a;
    word-break: break-word;
  }

  .error-message {
    color:#991b1b;
    background:#fee2e2;
    border:1px solid #fecaca;
    padding:10px 12px;
    border-radius:8px;
    font-size:12px;
    margin-bottom: 16px;
    display:none;
    line-height: 1.35;
  }

  button {
    padding: 10px 16px;
    border:none;
    border-radius:8px;
    font-size:14px;
    font-weight:700;
    cursor:pointer;
    transition:all .2s;
  }

  .btn-danger{
    background:#dc2626;
    color:#fff;
    padding:8px 12px;
    border:none;
    border-radius:8px;
    font-weight:700;
    cursor:pointer;
    width: 100%;
  }
  .btn-danger:hover{background:#b91c1c;}
  .btn-danger:disabled{background:#fca5a5;cursor:not-allowed;}

  .btn-primary {
    background:#16a34a;
    color:#fff;
    width:100%;
  }
  .btn-primary:hover { background:#15803d; }
  .btn-primary:disabled { background:#d1d5db; cursor:not-allowed; }

 .table-wrap{
  width:100%;
  max-width:100%;
  overflow-x:auto;          /* ‚úÖ ta≈ümayƒ± i√ßeride kaydƒ±r */
  overflow-y:hidden;
  -webkit-overflow-scrolling: touch;
}

table{
  width:100%;
  border-collapse:collapse;
  font-size: 13px;
  min-width: 720px;         /* istersen kalsƒ±n; artƒ±k ta≈ümaz, i√ßeride scroll olur */
}


  thead tr {
    background:#f9fafb;
    border-bottom: 2px solid #e5e7eb;
  }

  th, td { padding: 12px; }
  th {
    text-align:left;
    color:#374151;
    font-weight:700;
    white-space: nowrap;
  }
  td {
    border-bottom: 1px solid #e5e7eb;
    color:#0f172a;
    vertical-align: top;
    min-width: 0;
  }
  td.amount {
    text-align:right;
    color:#16a34a;
    font-weight:800;
    white-space:nowrap;
  }
  td.muted { color:#9ca3af; }

  .link{
    color:#2563eb;
    font-weight:600;
    text-decoration:none;
    display:inline-flex;
    align-items:center;
    gap:6px;
  }
  .link:hover{text-decoration:underline;}

  .receipt-link{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid #e5e7eb;
    text-decoration:none;
    font-weight:700;
    font-size:12px;
    color:#0f172a;
    background:#fff;
    transition: all .2s ease;
    white-space: nowrap;
  }
  .receipt-link:hover{
    border-color:#3b82f6;
    box-shadow:0 2px 6px rgba(59,130,246,.12);
  }
 



</style>

<div class="pay-body">
  <div class="container">

    <!-- SOL: √ñDEME FORMU -->
    <section class="card">
      <h2>üí≥ {{ tp('new_payment_title') }}</h2>

      <div id="errorMessage" class="error-message"></div>

      <form method="POST" action="{{ url_for('admin.manage_payments') }}" id="paymentForm">
        <!-- Daire -->
        <div class="form-group">
          <label for="apartmentSelect">{{ tp('label_apartment') }}</label>
          <select id="apartmentSelect" name="apartment_id" required>
            <option value="">{{ tp('apartment_pick') }}</option>
            {% for a in apartments %}
              <option value="{{ a.id }}">{{ a.block }} Blok, Kat {{ a.floor }}, No {{ a.number }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Bor√ß listesi -->
        <div class="form-group">
          <label>{{ tp('label_unpaid_bills') }}</label>
          <div class="bills-container" id="billsContainer">
            <div class="muted" style="text-align:center; padding:18px 8px;">{{ tp('unpaid_hint') }}</div>
          </div>
          <input type="hidden" name="bill_id" id="billIdHidden" value="">
          <input type="hidden" name="bill_type" id="billTypeHidden" value="">
        </div>

        <!-- Bor√ß detay -->
        <div id="billDetails" style="display:none;">
          <div class="divider"></div>
          <h3 style="font-size:14px; margin-bottom:12px; color:#0f172a;">{{ tp('selected_bill_title') }}</h3>
          <div class="info-box">
            <div style="margin-bottom:8px;"><strong>{{ tp('bill_desc') }}:</strong> <span id="billDesc">-</span></div>
            <div style="margin-bottom:8px;"><strong>{{ tp('bill_total') }}:</strong> ‚Ç∫<span id="billAmount">0.00</span></div>
            <div style="margin-bottom:8px;"><strong>{{ tp('bill_paid') }}:</strong> ‚Ç∫<span id="billPaid">0.00</span></div>
            <div><strong>{{ tp('bill_remaining') }}:</strong> <span class="remaining-amount">‚Ç∫<span id="billRemaining">0.00</span></span></div>
          </div>
        </div>

        <div class="divider"></div>

        <!-- √ñdeme bilgileri -->
        <div class="form-group">
          <label for="paymentAmount">{{ tp('label_amount') }}</label>
          <input type="number" id="paymentAmount" name="amount" step="0.01" min="0" placeholder="500.00" required>
        </div>

        <div class="grid-2">
          <div class="form-group">
            <label for="paymentDate">{{ tp('label_payment_date') }}</label>
            <input type="date" id="paymentDate" name="payment_date" required>
          </div>

          <div class="form-group">
            <label for="paymentMethod">{{ tp('label_method') }}</label>
            <select id="paymentMethod" name="method">
              <option value="">{{ tp('method_none') }}</option>
              <option value="nakit">üíµ {{ tp('method_cash') }}</option>
              <option value="banka">üè¶ {{ tp('method_bank') }}</option>
              <option value="pos">üí≥ {{ tp('method_pos') }}</option>
              <option value="online">üì± {{ tp('method_online') }}</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label for="payer">{{ tp('label_payer') }}</label>
          <select id="payer" name="user_id">
            <option value="">{{ tp('payer_unknown') }}</option>
            {% for u in users %}
              <option value="{{ u.id }}">{{ u.name }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- √ñdeme √∂zeti -->
        <div id="paymentSummary" style="display:none;">
          <div class="divider"></div>
          <h3 style="font-size:14px; margin-bottom:12px; color:#0f172a;">{{ tp('payment_summary') }}</h3>
          <div class="summary-grid">
            <div class="summary-card">
              <div class="summary-label">{{ tp('summary_pay') }}</div>
              <div class="summary-value">‚Ç∫<span id="summaryAmount">0.00</span></div>
            </div>
            <div class="summary-card">
              <div class="summary-label">{{ tp('summary_new_remaining') }}</div>
              <div class="summary-value" style="color:#dc2626;">‚Ç∫<span id="summaryNewRemaining">0.00</span></div>
            </div>
            <div class="summary-card">
              <div class="summary-label">{{ tp('summary_status') }}</div>
              <div style="margin-top:8px;">
                <span id="summaryStatus" class="status-badge status-open">{{ tp('status_open') }}</span>
              </div>
            </div>
          </div>
        </div>

        <button class="btn-primary" type="submit" id="savePayment">üíæ {{ tp('btn_save_payment') }}</button>
      </form>
    </section>

    <!-- SAƒû: √ñDEME TARƒ∞H√áESƒ∞ -->
    <section class="card">
      <h2>üìä {{ tp('list_title') }}</h2>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th style="min-width:100px;">{{ tp('col_apartment') }}</th>
              <th style="min-width:160px;">{{ tp('col_related') }}</th>
              <th style="text-align:right; min-width:120px;">{{ tp('col_amount') }}</th>
              <th style="min-width:100px;">{{ tp('col_date') }}</th>
              <th style="min-width:100px;">{{ tp('col_method') }}</th>
              <th style="min-width:120px;">{{ tp('col_receipt') }}</th>
              <th style="min-width:110px;">{{ tp('col_actions') }}</th>
            </tr>
          </thead>
          <tbody>
            {% if payments %}
              {% for payment, apt, user, bill in payments %}
                <tr>
                  <td data-label="{{ tp('col_apartment') }}" style="white-space:nowrap;">{{ apt.block }} Blok ‚Ä¢ {{ apt.floor }}/{{ apt.number }}</td>

                  <td data-label="{{ tp('col_related') }}">
                    {% set t = None %}
                    {% if bill and bill.type %}{% set t = bill.type %}{% endif %}
                    {% if not t and payment.bill_type is defined and payment.bill_type %}{% set t = payment.bill_type %}{% endif %}
                    {% if t %}
                      {% if t == 'aidat' %}üí∞ Aidat
                      {% elif t == 'elektrik' %}‚ö° Elektrik
                      {% elif t == 'su' %}üíß Su
                      {% elif t == 'dogalgaz' %}üî• Doƒüalgaz
                      {% elif t == 'ekstra' %}üì¶ Ekstra
                      {% else %}{{ t|capitalize }}
                      {% endif %}
                    {% else %}
                      <span class="muted">-</span>
                    {% endif %}
                    {% if bill and bill.description %}
                      <div style="font-size:12px; color:#6b7280; margin-top:4px; line-height:1.35; word-break:break-word;">{{ bill.description }}</div>
                    {% endif %}
                  </td>

                  <td data-label="{{ tp('col_amount') }}" class="amount">‚Ç∫ {{ "%.2f"|format(payment.amount) }}</td>

                  <td data-label="{{ tp('col_date') }}" style="white-space:nowrap;">{{ payment.payment_date.strftime("%d.%m.%Y") if payment.payment_date else "-" }}</td>

                  <td data-label="{{ tp('col_method') }}">{{ payment.method or "-" }}</td>

                  <td data-label="{{ tp('col_receipt') }}" style="white-space:nowrap;">
                    <a class="receipt-link" href="{{ url_for('admin.payment_receipt', payment_id=payment.id) }}" target="_blank">üìÑ PDF</a>
                  </td>

                  <td data-label="{{ tp('col_actions') }}" style="white-space:nowrap;">
                    <button type="button"
                            class="btn-danger btn-delete-payment"
                            data-delete-url="{{ url_for('admin.delete_payment', payment_id=payment.id) }}">
                      {{ tp('btn_delete') }}
                    </button>
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="7" class="muted" style="text-align:center; padding: 32px 12px;">{{ tp('empty') }}</td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </section>

  </div>
</div>

<script>
  // Backend'den hazƒ±r gelen bor√ß payload'u (admin_routes.py i√ßinde hazƒ±rlanƒ±r)
  const BILLS = {{ (bills_payload or [])|tojson }};

  const labels = {
    billTypes: {
      aidat: "üí∞ Aidat",
      elektrik: "‚ö° Elektrik",
      su: "üíß Su",
      dogalgaz: "üî• Doƒüalgaz",
      ekstra: "üì¶ Ekstra"
    },
    errApartment: {{ tp('err_apartment')|tojson }},
    errBill: {{ tp('err_bill')|tojson }},
    errAmount: {{ tp('err_amount')|tojson }},
    errDate: {{ tp('err_date')|tojson }},
    errMaxPrefix: {{ tp('err_max')|tojson }},
    unpaidHint: {{ tp('unpaid_hint')|tojson }},
    noUnpaid: {{ tp('no_unpaid')|tojson }},
    statusOpen: {{ tp('status_open')|tojson }},
    statusPartial: {{ tp('status_partial')|tojson }},
    statusPaid: {{ tp('status_paid')|tojson }},
    confirmDelete: {{ tp('confirm_delete')|tojson }},
    deleteOk: {{ tp('delete_ok')|tojson }},
    deleteFail: {{ tp('delete_fail')|tojson }}
  };

  let selectedBill = null;

  // Elements
  const apartmentSelect = document.getElementById('apartmentSelect');
  const billsContainer = document.getElementById('billsContainer');
  const paymentAmount = document.getElementById('paymentAmount');
  const paymentDate = document.getElementById('paymentDate');
  const paymentMethod = document.getElementById('paymentMethod');
  const payer = document.getElementById('payer');
  const savePayment = document.getElementById('savePayment');
  const billDetails = document.getElementById('billDetails');
  const paymentSummary = document.getElementById('paymentSummary');
  const errorMessage = document.getElementById('errorMessage');
  const billIdHidden = document.getElementById('billIdHidden');
  const billTypeHidden = document.getElementById('billTypeHidden');

  // Bug√ºn√ºn tarihi
  (function setToday(){
    const today = new Date().toISOString().split('T')[0];
    if (!paymentDate.value) paymentDate.value = today;
  })();

  function showError(msg){
    errorMessage.textContent = "‚ùå " + msg;
    errorMessage.style.display = "block";
  }
  function clearError(){
    errorMessage.style.display = "none";
    errorMessage.textContent = "";
  }

  function money(n){
    const x = Number(n || 0);
    return x.toFixed(2);
  }

  function renderBills(apartmentId){
    selectedBill = null;
    billIdHidden.value = "";
    billTypeHidden.value = "";
    billDetails.style.display = "none";
    paymentSummary.style.display = "none";
    paymentAmount.value = "";
    paymentAmount.removeAttribute("max");

    if (!apartmentId){
      billsContainer.innerHTML = `<div class="muted" style="text-align:center; padding:18px 8px;">${labels.unpaidHint}</div>`;
      return;
    }

    const debts = BILLS.filter(b => String(b.apartment_id) === String(apartmentId));
    const unpaid = debts.filter(b => Number(b.remaining || 0) > 0);

    if (unpaid.length === 0){
      billsContainer.innerHTML = `<div class="muted" style="text-align:center; padding:18px 8px;">‚úÖ ${labels.noUnpaid}</div>`;
      return;
    }

    billsContainer.innerHTML = unpaid.map(bill => {
      const typeLabel = labels.billTypes[bill.type] || bill.type || "-";
      const statusClass = (bill.paid > 0) ? "status-partial" : "status-open";
      const statusText = (bill.paid > 0) ? labels.statusPartial : labels.statusOpen;

      return `
        <div class="bill-item" data-bill-id="${bill.id}">
          <div style="display:flex; gap:10px; align-items:flex-start;">
            <input type="radio" name="selectedBillRadio" value="${bill.id}" style="width:auto; margin-top:3px;">
            <div style="flex:1; min-width:0;">
              <div class="bill-header">
                <span>${typeLabel}</span>
                <span class="status-badge ${statusClass}" style="padding:2px 6px; font-size:10px;">${statusText}</span>
              </div>
              <div class="bill-info">${(bill.description || "-")}</div>

              <div class="bill-amounts">
                <div class="amount-box">
                  <div class="amount-label">Tutar</div>
                  <div class="amount-value">‚Ç∫${money(bill.amount)}</div>
                </div>
                <div class="amount-box">
                  <div class="amount-label">√ñdenmi≈ü</div>
                  <div class="amount-value paid-amount">‚Ç∫${money(bill.paid)}</div>
                </div>
                <div class="amount-box">
                  <div class="amount-label">Kalan</div>
                  <div class="amount-value remaining-amount">‚Ç∫${money(bill.remaining)}</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }).join("");

    // bind radios
    billsContainer.querySelectorAll('input[name="selectedBillRadio"]').forEach(radio => {
      radio.addEventListener('change', function(){
        const billId = Number(this.value);
        selectedBill = unpaid.find(b => Number(b.id) === billId) || null;

        billsContainer.querySelectorAll('.bill-item').forEach(it => it.classList.remove('selected'));
        const wrap = this.closest('.bill-item');
        if (wrap) wrap.classList.add('selected');

        updateBillDetails();
      });
    });

    // tƒ±klayƒ±nca da se√ßsin
    billsContainer.querySelectorAll('.bill-item').forEach(item => {
      item.addEventListener('click', function(e){
        const radio = item.querySelector('input[name="selectedBillRadio"]');
        if (!radio) return;
        if (e.target && (e.target.tagName === "INPUT")) return;
        radio.checked = true;
        radio.dispatchEvent(new Event('change'));
      });
    });
  }

  function updateBillDetails(){
    if (!selectedBill){
      billDetails.style.display = "none";
      billIdHidden.value = "";
      billTypeHidden.value = "";
      paymentAmount.removeAttribute("max");
      paymentSummary.style.display = "none";
      return;
    }

    document.getElementById("billDesc").textContent = selectedBill.description || "-";
    document.getElementById("billAmount").textContent = money(selectedBill.amount);
    document.getElementById("billPaid").textContent = money(selectedBill.paid);
    document.getElementById("billRemaining").textContent = money(selectedBill.remaining);

    billDetails.style.display = "block";

    billIdHidden.value = String(selectedBill.id);
    billTypeHidden.value = selectedBill.type || "";

    paymentAmount.max = String(Number(selectedBill.remaining || 0));
  }

  paymentAmount.addEventListener("input", function(){
    if (!selectedBill){
      paymentSummary.style.display = "none";
      return;
    }

    const amount = Number(this.value || 0);
    const remaining = Number(selectedBill.remaining || 0);
    const newRemaining = remaining - amount;

    if (amount > 0){
      document.getElementById("summaryAmount").textContent = money(amount);
      document.getElementById("summaryNewRemaining").textContent = money(Math.max(0, newRemaining));

      const statusSpan = document.getElementById("summaryStatus");
      statusSpan.style.background = "";
      statusSpan.style.color = "";
      if (newRemaining <= 0){
        statusSpan.textContent = labels.statusPaid;
        statusSpan.className = "status-badge status-paid";
      } else {
        statusSpan.textContent = labels.statusPartial;
        statusSpan.className = "status-badge status-partial";
      }

      paymentSummary.style.display = "block";
    } else {
      paymentSummary.style.display = "none";
    }
  });

  apartmentSelect.addEventListener("change", function(){
    clearError();
    renderBills(this.value);
  });

  // submit validation (frontend)
  document.getElementById("paymentForm").addEventListener("submit", function(e){
    clearError();

    if (!apartmentSelect.value){
      e.preventDefault();
      showError(labels.errApartment);
      return;
    }
    if (!selectedBill){
      e.preventDefault();
      showError(labels.errBill);
      return;
    }

    const amt = Number(paymentAmount.value || 0);
    if (!(amt > 0)){
      e.preventDefault();
      showError(labels.errAmount);
      return;
    }
    const remaining = Number(selectedBill.remaining || 0);
    if (amt > remaining + 1e-9){
      e.preventDefault();
      showError(labels.errMaxPrefix + "‚Ç∫" + money(remaining));
      return;
    }
    if (!paymentDate.value){
      e.preventDefault();
      showError(labels.errDate);
      return;
    }
  });

  // =========================
  // √ñdeme silme (AJAX)
  // =========================
  document.addEventListener('click', async function(e){
    const btn = e.target.closest('.btn-delete-payment');
    if(!btn) return;

    const url = btn.getAttribute('data-delete-url');
    if(!url) return;

    if(!confirm(labels.confirmDelete)) return;

    btn.disabled = true;

    try{
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      });

      const data = await res.json().catch(()=>null);

      if(res.ok && data && data.ok){
        const tr = btn.closest('tr');
        if(tr) tr.remove();
        alert("‚úÖ " + labels.deleteOk);
      }else{
        alert("‚ùå " + ((data && data.error) ? data.error : labels.deleteFail));
        btn.disabled = false;
      }
    }catch(err){
      alert("‚ùå " + labels.deleteFail);
      btn.disabled = false;
    }
  });

</script>

{% endblock %}
