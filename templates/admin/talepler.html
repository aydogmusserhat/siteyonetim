{% extends "base.html" %}

{# ============================================================
   TALEPLER (ADMIN) - 4 DİL (TR / EN / ME / RU) UYUMLU
   ============================================================ #}

{% set LANG = session.get('lang','tr') %}

{% set I18N_PAGE = {
  'tr': {
    'page_title': 'Talepler',
    'topbar_title': 'Sakin Talepleri',
    'card_title': 'Sakin Talepleri',

    'filter_label': 'Duruma göre filtre:',
    'filter_all': 'Tümü',
    'filter_open': 'Açık',
    'filter_in_progress': 'Devam ediyor',
    'filter_closed': 'Kapalı',

    'col_date': 'Tarih',
    'col_apartment': 'Daire',
    'col_resident': 'Sakin',
    'col_title': 'Başlık',
    'col_status': 'Durum',
    'col_priority': 'Öncelik',
    'col_action': 'İşlem',

    'apt_unspecified': 'Belirtilmemiş',
    'dash': '-',

    'status_closed': 'Kapalı',
    'status_in_progress': 'Devam ediyor',
    'status_open': 'Açık',

    'priority_high': 'Yüksek',
    'priority_low': 'Düşük',
    'priority_normal': 'Normal',

    'select_open': 'Açık',
    'select_in_progress': 'Devam',
    'select_closed': 'Kapalı',

    'btn_save': 'Kaydet',

    'empty': 'Kayıtlı talep bulunmuyor.'
  },

  'en': {
    'page_title': 'Requests',
    'topbar_title': 'Resident Requests',
    'card_title': 'Resident Requests',

    'filter_label': 'Filter by status:',
    'filter_all': 'All',
    'filter_open': 'Open',
    'filter_in_progress': 'In progress',
    'filter_closed': 'Closed',

    'col_date': 'Date',
    'col_apartment': 'Apartment',
    'col_resident': 'Resident',
    'col_title': 'Title',
    'col_status': 'Status',
    'col_priority': 'Priority',
    'col_action': 'Action',

    'apt_unspecified': 'Not specified',
    'dash': '-',

    'status_closed': 'Closed',
    'status_in_progress': 'In progress',
    'status_open': 'Open',

    'priority_high': 'High',
    'priority_low': 'Low',
    'priority_normal': 'Normal',

    'select_open': 'Open',
    'select_in_progress': 'Progress',
    'select_closed': 'Closed',

    'btn_save': 'Save',

    'empty': 'No requests found.'
  },

  'me': {
    'page_title': 'Zahtjevi',
    'topbar_title': 'Zahtjevi stanara',
    'card_title': 'Zahtjevi stanara',

    'filter_label': 'Filtriraj po statusu:',
    'filter_all': 'Svi',
    'filter_open': 'Otvoreno',
    'filter_in_progress': 'U toku',
    'filter_closed': 'Zatvoreno',

    'col_date': 'Datum',
    'col_apartment': 'Stan',
    'col_resident': 'Stanar',
    'col_title': 'Naslov',
    'col_status': 'Status',
    'col_priority': 'Prioritet',
    'col_action': 'Akcija',

    'apt_unspecified': 'Nije navedeno',
    'dash': '-',

    'status_closed': 'Zatvoreno',
    'status_in_progress': 'U toku',
    'status_open': 'Otvoreno',

    'priority_high': 'Visok',
    'priority_low': 'Nizak',
    'priority_normal': 'Normalan',

    'select_open': 'Otvoreno',
    'select_in_progress': 'U toku',
    'select_closed': 'Zatvoreno',

    'btn_save': 'Sačuvaj',

    'empty': 'Nema evidentiranih zahtjeva.'
  },

  'ru': {
    'page_title': 'Заявки',
    'topbar_title': 'Заявки жильцов',
    'card_title': 'Заявки жильцов',

    'filter_label': 'Фильтр по статусу:',
    'filter_all': 'Все',
    'filter_open': 'Открыто',
    'filter_in_progress': 'В процессе',
    'filter_closed': 'Закрыто',

    'col_date': 'Дата',
    'col_apartment': 'Квартира',
    'col_resident': 'Жилец',
    'col_title': 'Заголовок',
    'col_status': 'Статус',
    'col_priority': 'Приоритет',
    'col_action': 'Действие',

    'apt_unspecified': 'Не указано',
    'dash': '-',

    'status_closed': 'Закрыто',
    'status_in_progress': 'В процессе',
    'status_open': 'Открыто',

    'priority_high': 'Высокий',
    'priority_low': 'Низкий',
    'priority_normal': 'Обычный',

    'select_open': 'Открыто',
    'select_in_progress': 'В процессе',
    'select_closed': 'Закрыто',

    'btn_save': 'Сохранить',

    'empty': 'Заявок не найдено.'
  }
} %}

{% macro tp(k) -%}
  {{ I18N_PAGE.get(LANG, I18N_PAGE['tr']).get(k, I18N_PAGE['tr'].get(k, k)) }}
{%- endmacro %}

{% block title %}{{ tp('page_title') }}{% endblock %}
{% block topbar_title %}
  {{ tp('topbar_title') }}
  {% if session.active_site_name %}
    – {{ session.active_site_name }}
  {% elif current_site_name %}
    – {{ current_site_name }}
  {% endif %}
{% endblock %}

{% block content %}

<div class="card">
  <h2 style="font-size:16px; margin-bottom:8px;">{{ tp('card_title') }}</h2>

  <form method="get" style="margin-bottom:10px; display:flex; flex-wrap:wrap; gap:8px; align-items:center;">
    <label for="status" style="font-size:13px; color:#4b5563;">{{ tp('filter_label') }}</label>
    <select
      id="status"
      name="status"
      onchange="this.form.submit()"
      style="padding:6px 9px; border-radius:999px; border:1px solid #e5e7eb; font-size:13px;">
      <option value="all" {% if status_filter == 'all' %}selected{% endif %}>{{ tp('filter_all') }}</option>
      <option value="open" {% if status_filter == 'open' %}selected{% endif %}>{{ tp('filter_open') }}</option>
      <option value="in_progress" {% if status_filter == 'in_progress' %}selected{% endif %}>{{ tp('filter_in_progress') }}</option>
      <option value="closed" {% if status_filter == 'closed' %}selected{% endif %}>{{ tp('filter_closed') }}</option>
    </select>
  </form>

  {% if tickets %}
    <div style="width:100%; overflow-x:auto;">
      <table style="width:100%; border-collapse:collapse; font-size:12px;">
        <thead>
          <tr style="background:#f9fafb; border-bottom:1px solid #e5e7eb;">
            <th style="text-align:left; padding:6px 4px;">{{ tp('col_date') }}</th>
            <th style="text-align:left; padding:6px 4px;">{{ tp('col_apartment') }}</th>
            <th style="text-align:left; padding:6px 4px;">{{ tp('col_resident') }}</th>
            <th style="text-align:left; padding:6px 4px;">{{ tp('col_title') }}</th>
            <th style="text-align:left; padding:6px 4px;">{{ tp('col_status') }}</th>
            <th style="text-align:left; padding:6px 4px;">{{ tp('col_priority') }}</th>
            <th style="text-align:left; padding:6px 4px;">{{ tp('col_action') }}</th>
          </tr>
        </thead>
        <tbody>
          {% for t, apt, u in tickets %}
            <tr style="border-bottom:1px solid #f3f4f6;">
              <td style="padding:6px 4px; white-space:nowrap;">
                {% if t.created_at %}
                  {{ t.created_at.strftime('%d.%m.%Y %H:%M') }}
                {% else %}
                  {{ tp('dash') }}
                {% endif %}
              </td>
              <td style="padding:6px 4px; white-space:nowrap;">
                {% if apt %}
                  {{ apt.block }} Blok • {{ apt.floor }}/{{ apt.number }}
                {% else %}
                  <span style="color:#9ca3af;">{{ tp('apt_unspecified') }}</span>
                {% endif %}
              </td>
              <td style="padding:6px 4px; white-space:nowrap;">
                {% if u %}
                  {{ u.name }}
                {% else %}
                  <span style="color:#9ca3af;">{{ tp('dash') }}</span>
                {% endif %}
              </td>
              <td style="padding:6px 4px; max-width:260px;">
                <div style="font-weight:600; margin-bottom:2px;">
                  {{ t.title }}
                </div>
                <div style="font-size:11px; color:#6b7280; max-width:430px; white-space:normal; overflow:visible; word-break:break-word;">
                  {{ t.description }}
                </div>

              </td>
              <td style="padding:6px 4px; white-space:nowrap;">
                {% if t.status == 'closed' %}
                  <span style="padding:2px 8px; border-radius:999px; background:#dcfce7; color:#15803d;">{{ tp('status_closed') }}</span>
                {% elif t.status == 'in_progress' %}
                  <span style="padding:2px 8px; border-radius:999px; background:#fef9c3; color:#854d0e;">{{ tp('status_in_progress') }}</span>
                {% else %}
                  <span style="padding:2px 8px; border-radius:999px; background:#fee2e2; color:#b91c1c;">{{ tp('status_open') }}</span>
                {% endif %}
              </td>
              <td style="padding:6px 4px; white-space:nowrap;">
                {% if t.priority == 'high' %}
                  <span style="color:#b91c1c;">{{ tp('priority_high') }}</span>
                {% elif t.priority == 'low' %}
                  <span style="color:#15803d;">{{ tp('priority_low') }}</span>
                {% else %}
                  {{ tp('priority_normal') }}
                {% endif %}
              </td>
              <td style="padding:6px 4px; white-space:nowrap;">
                <form method="post"
                      action="{{ url_for('admin.update_ticket_status', ticket_id=t.id, status=status_filter) }}"
                      style="display:inline-flex; gap:4px; align-items:center;">
                  <select name="status"
                          style="padding:3px 7px; border-radius:999px; border:1px solid #e5e7eb; font-size:11px;">
                    <option value="open" {% if t.status == 'open' %}selected{% endif %}>{{ tp('select_open') }}</option>
                    <option value="in_progress" {% if t.status == 'in_progress' %}selected{% endif %}>{{ tp('select_in_progress') }}</option>
                    <option value="closed" {% if t.status == 'closed' %}selected{% endif %}>{{ tp('select_closed') }}</option>
                  </select>
                  <button type="submit"
                          style="padding:4px 8px; border-radius:999px; border:none; background:#2563eb; color:white; font-size:11px; cursor:pointer;">
                    {{ tp('btn_save') }}
                  </button>
                </form>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p style="font-size:13px; color:#6b7280;">
      {{ tp('empty') }}
    </p>
  {% endif %}

</div>

{% endblock %}
