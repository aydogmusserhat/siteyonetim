{% extends "base.html" %}

{% block title %}Audit Detay{% endblock %}
{% block topbar_title %}Audit Kayıt Detayı — #{{ log.id }}{% endblock %}

{% block content %}

<style>
  /* Genel */
  .wrap { display:flex; flex-direction:column; gap:14px; max-width:1100px; margin:0 auto; }
  .head {
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:12px;
    flex-wrap:wrap;
  }

  /* Badge */
  .badge {
    display:inline-flex; align-items:center; gap:6px;
    padding:6px 10px; border-radius:999px;
    font-size:12px; font-weight:800;
    border:1px solid #e5e7eb;
    background:#fff;
    white-space:nowrap;
  }
  .badge-success { border-color:#bbf7d0; background:#f0fdf4; color:#166534; }
  .badge-failure { border-color:#fecaca; background:#fef2f2; color:#991b1b; }

  /* Grid */
  .grid {
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:12px;
  }

  /* Kart/Kutu */
  .box {
    border:1px solid #e5e7eb;
    border-radius:16px;
    background:#fff;
    padding:12px;
    overflow:hidden; /* mobilde kırpma yerine içeride kaydırma kontrolü */
  }

  /* Key-Value */
  .kv {
    display:grid;
    grid-template-columns: 140px 1fr;
    gap:8px 10px;
    font-size:14px;
    align-items:start;
  }
  .k { color:#6b7280; font-weight:600; }
  .v {
    color:#111827;
    word-break:break-word;
    overflow-wrap:anywhere;
    min-width:0;
  }

  /* Kod blokları */
  .json-block {
    margin:0;
    padding:12px;
    border-radius:14px;
    background:#0b1220;
    color:#e5e7eb;
    overflow:auto;
    font-size:12px;
    line-height:1.45;
    max-height:520px; /* desktop */
    white-space:pre;  /* json düzeni korunsun */
  }

  /* Buton */
  .btn {
    padding:10px 14px;
    border:none;
    border-radius:12px;
    cursor:pointer;
    font-size:14px;
    font-weight:700;
    text-decoration:none;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    white-space:nowrap;
  }
  .btn-ghost { background:#f3f4f6; color:#111827; }

  /* Başlık satırları */
  .title-line {
    font-size:16px;
    font-weight:900;
    line-height:1.25;
    word-break:break-word;
    overflow-wrap:anywhere;
  }
  .sub-line {
    color:#6b7280;
    font-size:13px;
    margin-top:4px;
    line-height:1.35;
    word-break:break-word;
    overflow-wrap:anywhere;
  }

  /* Aksiyon alanı */
  .actions {
    display:flex;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
    justify-content:flex-end;
  }

  /* --- Responsive --- */

  /* Tablet ve altı: tek kolona düş */
  @media (max-width: 980px) {
    .wrap { max-width:100%; padding:0 2px; }
    .grid { grid-template-columns: 1fr; }
    .box { padding:12px; }
    .kv { grid-template-columns: 120px 1fr; font-size:13px; }
    .json-block { max-height:420px; }
  }

  /* Mobil: daha rahat okuma */
  @media (max-width: 640px) {
    .head { gap:10px; }
    .title-line { font-size:15px; }
    .sub-line { font-size:12px; }
    .kv { grid-template-columns: 1fr; }
    .k { font-size:12px; }
    .v { font-size:13px; }

    .actions { width:100%; justify-content:stretch; }
    .btn { width:100%; }          /* Listeye dön butonu full genişlik */
    .badge { font-size:12px; }

    .json-block {
      font-size:11px;
      padding:10px;
      max-height:340px;
      border-radius:12px;
    }
  }

  /* Çok küçük ekran: padding ve font biraz daha kıs */
  @media (max-width: 380px) {
    .json-block { font-size:10.5px; }
  }
</style>

<div class="wrap">

  <div class="card">
    <div class="head">
      <div style="min-width:0;">
        <div class="title-line">
          #{{ log.id }} — {{ log.action }} {{ log.entity_type }}
          {% if log.entity_id is not none %} (entity_id={{ log.entity_id }}){% endif %}
        </div>
        <div class="sub-line">
          {{ log.created_at.strftime("%d.%m.%Y %H:%M:%S") if log.created_at else "-" }}
          • IP: {{ log.ip_address or "-" }}
        </div>
      </div>

      <div class="actions">
        {% if log.status == "success" %}
          <span class="badge badge-success">success</span>
        {% else %}
          <span class="badge badge-failure">failure</span>
        {% endif %}
        <a class="btn btn-ghost" href="{{ url_for('admin.audit_logs') }}">← Listeye Dön</a>
      </div>
    </div>
  </div>

  <div class="grid">
    <div class="box">
      <div style="font-weight:900; margin-bottom:10px;">Genel Bilgiler</div>

      <div class="kv">
        <div class="k">Kullanıcı</div>
        <div class="v">
          {% if log.user %}
            {{ log.user.name }} (id={{ log.user_id }}, role={{ log.user.role }})
          {% else %}
            Sistem / Bilinmiyor (user_id={{ log.user_id }})
          {% endif %}
        </div>

        <div class="k">Site</div>
        <div class="v">
          {% if log.site %}
            {{ log.site.name }} (id={{ log.site_id }})
          {% else %}
            - (site_id={{ log.site_id }})
          {% endif %}
        </div>

        <div class="k">Açıklama</div>
        <div class="v">{{ log.description or "-" }}</div>

        <div class="k">User-Agent</div>
        <div class="v">{{ log.user_agent or "-" }}</div>

        {% if log.error_message %}
          <div class="k">Hata</div>
          <div class="v" style="color:#991b1b; font-weight:800;">{{ log.error_message }}</div>
        {% endif %}
      </div>
    </div>

    <div class="box">
      <div style="font-weight:900; margin-bottom:10px;">Değişiklik Detayı</div>

      <div style="display:flex; flex-direction:column; gap:10px;">
        <div>
          <div class="k" style="font-weight:900; margin-bottom:6px;">old_values</div>
          <pre class="json-block">{{ old_data | tojson(indent=2) if old_data is not none else "null" }}</pre>
        </div>

        <div>
          <div class="k" style="font-weight:900; margin-bottom:6px;">new_values</div>
          <pre class="json-block">{{ new_data | tojson(indent=2) if new_data is not none else "null" }}</pre>
        </div>
      </div>
    </div>
  </div>

</div>

{% endblock %}
