{% extends "base.html" %}

{# ============================================================
   DUYURULAR - 3 DÄ°L (TR / EN / ME) UYUMLU
   ============================================================ #}

{% set LANG = session.get('lang','tr') %}

{% set I18N_PAGE = {
  'tr': {
    'page_title': 'Duyurular',
    'topbar_title': 'Duyuru YÃ¶netimi',

    'new_card_title': 'Yeni Duyuru YayÄ±nla',
    'label_title': 'BaÅŸlÄ±k',
    'ph_title': 'Ã–rn: AsansÃ¶r BakÄ±m Ã‡alÄ±ÅŸmasÄ±',

    'label_content': 'Ä°Ã§erik',
    'ph_content': 'Duyuru metnini buraya yazÄ±n...',

    'label_target': 'Hedef Kitle',
    'target_all': 'TÃ¼m sakinler',
    'target_admins': 'Sadece yÃ¶neticiler',

    'btn_publish': 'Duyuruyu YayÄ±nla',

    'list_title': 'YayÄ±nlanan Duyurular',

    'target_prefix': 'Hedef:',
    'target_admins_short': 'YÃ¶neticiler',
    'target_all_short': 'TÃ¼m sakinler',

    'expired': '(SÃ¼resi doldu)',

    'publisher_prefix': 'YayÄ±nlayan:',
    'system': 'Sistem',

    'empty': 'HenÃ¼z yayÄ±nlanmÄ±ÅŸ bir duyuru bulunmuyor.'
  },

  'en': {
    'page_title': 'Announcements',
    'topbar_title': 'Announcement Management',

    'new_card_title': 'Publish New Announcement',
    'label_title': 'Title',
    'ph_title': 'e.g., Elevator Maintenance Work',

    'label_content': 'Content',
    'ph_content': 'Write the announcement text here...',

    'label_target': 'Audience',
    'target_all': 'All residents',
    'target_admins': 'Admins only',

    'btn_publish': 'Publish Announcement',

    'list_title': 'Published Announcements',

    'target_prefix': 'Target:',
    'target_admins_short': 'Admins',
    'target_all_short': 'All residents',

    'expired': '(Expired)',

    'publisher_prefix': 'Published by:',
    'system': 'System',

    'empty': 'There are no published announcements yet.'
  },

  'me': {
    'page_title': 'ObavjeÅ¡tenja',
    'topbar_title': 'Upravljanje obavjeÅ¡tenjima',

    'new_card_title': 'Objavi novo obavjeÅ¡tenje',
    'label_title': 'Naslov',
    'ph_title': 'npr. Servisiranje lifta',

    'label_content': 'SadrÅ¾aj',
    'ph_content': 'UpiÅ¡ite tekst obavjeÅ¡tenja ovdje...',

    'label_target': 'Ciljna grupa',
    'target_all': 'Svi stanari',
    'target_admins': 'Samo upravnici',

    'btn_publish': 'Objavi obavjeÅ¡tenje',

    'list_title': 'Objavljena obavjeÅ¡tenja',

    'target_prefix': 'Cilj:',
    'target_admins_short': 'Upravnici',
    'target_all_short': 'Svi stanari',

    'expired': '(Isteklo)',

    'publisher_prefix': 'Objavio/la:',
    'system': 'Sistem',

    'empty': 'JoÅ¡ nema objavljenih obavjeÅ¡tenja.'
  }
} %}

{% macro tp(k) -%}
  {{ I18N_PAGE.get(LANG, I18N_PAGE['tr']).get(k, I18N_PAGE['tr'].get(k, k)) }}
{%- endmacro %}

{% block title %}{{ tp('page_title') }}{% endblock %}
{% block topbar_title %}
  {{ tp('topbar_title') }}
  {% if session.active_site_name %}
    â€“ {{ session.active_site_name }}
  {% elif current_site_name %}
    â€“ {{ current_site_name }}
  {% endif %}
{% endblock %}

{% block content %}

<div class="dashboard-grid">

  <!-- SOL: YENÄ° DUYURU -->
  <section>
    <div class="card">
      <h2 style="font-size:16px; margin-bottom:12px;">{{ tp('new_card_title') }}</h2>

      <form method="post" style="display:flex; flex-direction:column; gap:10px;">

        <div>
          <label for="title" style="display:block; font-size:13px; margin-bottom:3px;">{{ tp('label_title') }}</label>
          <input
            type="text"
            id="title"
            name="title"
            required
            placeholder="{{ tp('ph_title') }}"
            style="width:100%; padding:7px 9px; border-radius:8px; border:1px solid #e5e7eb; font-size:13px;">
        </div>

        <div>
          <label for="content" style="display:block; font-size:13px; margin-bottom:3px;">{{ tp('label_content') }}</label>
          <textarea
            id="content"
            name="content"
            rows="4"
            required
            placeholder="{{ tp('ph_content') }}"
            style="width:100%; padding:7px 9px; border-radius:8px; border:1px solid #e5e7eb; font-size:13px; resize:vertical;"></textarea>
        </div>

        <div>
          <label for="target" style="display:block; font-size:13px; margin-bottom:3px;">{{ tp('label_target') }}</label>
          <select
            id="target"
            name="target"
            style="width:100%; padding:7px 9px; border-radius:8px; border:1px solid #e5e7eb; font-size:13px;">
            <option value="all">{{ tp('target_all') }}</option>
            <option value="admins">{{ tp('target_admins') }}</option>
          </select>
        </div>

        <div style="margin-top:4px;">
          <button type="submit"
                  style="padding:8px 12px; border-radius:999px; border:none; background:#2563eb; color:white; font-size:13px; cursor:pointer;">
            {{ tp('btn_publish') }}
          </button>
        </div>

      </form>
    </div>
  </section>

  <!-- SAÄž: DUYURU LÄ°STESÄ° -->
  <section>
    <div class="card">
      <h2 style="font-size:16px; margin-bottom:10px;">{{ tp('list_title') }}</h2>

      {% if announcements %}
        <ul style="list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:8px;">
          {% for ann, user in announcements %}
            {# ðŸ”¹ GÃ¼nÃ¼ geÃ§miÅŸ mi? created_at tarihi bugÃ¼nden kÃ¼Ã§Ã¼kse #}
            {% set is_expired = ann.created_at and (today - ann.created_at.date()).days >= 29 %}

            <li style="padding:8px 10px; border-radius:10px; background:#f9fafb; {% if is_expired %}opacity:0.6;{% endif %}">
              <div style="display:flex; justify-content:space-between; gap:8px; margin-bottom:4px;">
                <div style="font-size:13px; font-weight:600; {% if is_expired %}text-decoration:line-through;{% endif %}">
                  {{ ann.title }}
                </div>
                <div style="font-size:11px; color:#6b7280; white-space:nowrap;">
                  {{ ann.created_at.strftime('%d.%m.%Y %H:%M') if ann.created_at }}
                </div>
              </div>

              <div style="font-size:12px; color:#4b5563; margin-bottom:6px; {% if is_expired %}text-decoration:line-through;{% endif %}">
                {{ ann.content }}
              </div>

              <div style="display:flex; justify-content:space-between; font-size:11px; color:#6b7280;">
                <span>
                  {% if ann.target == "admins" %}
                    {{ tp('target_prefix') }} {{ tp('target_admins_short') }}
                  {% else %}
                    {{ tp('target_prefix') }} {{ tp('target_all_short') }}
                  {% endif %}
                  {% if is_expired %}
                    Â· <span style="font-style:italic;">{{ tp('expired') }}</span>
                  {% endif %}
                </span>
                <span>
                  {% if user %}
                    {{ tp('publisher_prefix') }} {{ user.name }}
                  {% else %}
                    {{ tp('system') }}
                  {% endif %}
                </span>
              </div>
            </li>
          {% endfor %}
        </ul>

      {% else %}
        <p style="font-size:13px; color:#6b7280;">
          {{ tp('empty') }}
        </p>
      {% endif %}
    </div>
  </section>

</div>

{% endblock %}
