{% extends "base.html" %}

{# ============================================================
   DUYURULAR - 4 Dƒ∞L (TR / EN / ME / RU) UYUMLU
   ============================================================ #}

{% set LANG = session.get('lang','tr') %}

{% set I18N_PAGE = {
  'tr': {
    'page_title': 'Duyurular',
    'topbar_title': 'Duyuru Y√∂netimi',

    'new_card_title': 'Yeni Duyuru Yayƒ±nla',
    'label_title': 'Ba≈ülƒ±k',
    'ph_title': '√ñrn: Asans√∂r Bakƒ±m √áalƒ±≈ümasƒ±',

    'label_content': 'ƒ∞√ßerik',
    'ph_content': 'Duyuru metnini buraya yazƒ±n...',

    'label_target': 'Hedef Kitle',
    'target_all': 'T√ºm sakinler',
    'target_admins': 'Sadece y√∂neticiler',

    'btn_publish': 'Duyuruyu Yayƒ±nla',

    'list_title': 'Yayƒ±nlanan Duyurular',

    'target_prefix': 'Hedef:',
    'target_admins_short': 'Y√∂neticiler',
    'target_all_short': 'T√ºm sakinler',

    'expired': '(S√ºresi doldu)',

    'publisher_prefix': 'Yayƒ±nlayan:',
    'system': 'Sistem',

    'empty': 'Hen√ºz yayƒ±nlanmƒ±≈ü bir duyuru bulunmuyor.'
  },

  'en': {
    'page_title': 'Announcements',
    'topbar_title': 'Announcement Management',

    'new_card_title': 'Publish New Announcement',
    'label_title': 'Title',
    'ph_title': 'e.g., Elevator Maintenance Work',

    'label_content': 'Content',
    'ph_content': 'Write the announcement text here...',

    'label_target': 'Audience',
    'target_all': 'All residents',
    'target_admins': 'Admins only',

    'btn_publish': 'Publish Announcement',

    'list_title': 'Published Announcements',

    'target_prefix': 'Target:',
    'target_admins_short': 'Admins',
    'target_all_short': 'All residents',

    'expired': '(Expired)',

    'publisher_prefix': 'Published by:',
    'system': 'System',

    'empty': 'There are no published announcements yet.'
  },

  'me': {
    'page_title': 'Obavje≈°tenja',
    'topbar_title': 'Upravljanje obavje≈°tenjima',

    'new_card_title': 'Objavi novo obavje≈°tenje',
    'label_title': 'Naslov',
    'ph_title': 'npr. Servisiranje lifta',

    'label_content': 'Sadr≈æaj',
    'ph_content': 'Upi≈°ite tekst obavje≈°tenja ovdje...',

    'label_target': 'Ciljna grupa',
    'target_all': 'Svi stanari',
    'target_admins': 'Samo upravnici',

    'btn_publish': 'Objavi obavje≈°tenje',

    'list_title': 'Objavljena obavje≈°tenja',

    'target_prefix': 'Cilj:',
    'target_admins_short': 'Upravnici',
    'target_all_short': 'Svi stanari',

    'expired': '(Isteklo)',

    'publisher_prefix': 'Objavio/la:',
    'system': 'Sistem',

    'empty': 'Jo≈° nema objavljenih obavje≈°tenja.'
  },

  'ru': {
    'page_title': '–û–±—ä—è–≤–ª–µ–Ω–∏—è',
    'topbar_title': '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è–º–∏',

    'new_card_title': '–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –Ω–æ–≤–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ',
    'label_title': '–ó–∞–≥–æ–ª–æ–≤–æ–∫',
    'ph_title': '–ù–∞–ø—Ä.: –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ –ª–∏—Ñ—Ç–∞',

    'label_content': '–¢–µ–∫—Å—Ç',
    'ph_content': '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è –∑–¥–µ—Å—å...',

    'label_target': '–ê—É–¥–∏—Ç–æ—Ä–∏—è',
    'target_all': '–í—Å–µ –∂–∏–ª—å—Ü—ã',
    'target_admins': '–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã',

    'btn_publish': '–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ',

    'list_title': '–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è',

    'target_prefix': '–ö–æ–º—É:',
    'target_admins_short': '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã',
    'target_all_short': '–í—Å–µ –∂–∏–ª—å—Ü—ã',

    'expired': '(–°—Ä–æ–∫ –∏—Å—Ç—ë–∫)',

    'publisher_prefix': '–û–ø—É–±–ª–∏–∫–æ–≤–∞–ª(–∞):',
    'system': '–°–∏—Å—Ç–µ–º–∞',

    'empty': '–ü–æ–∫–∞ –Ω–µ—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π.'
  }
} %}

{% macro tp(k) -%}
  {{ I18N_PAGE.get(LANG, I18N_PAGE['tr']).get(k, I18N_PAGE['tr'].get(k, k)) }}
{%- endmacro %}

{% block title %}{{ tp('page_title') }}{% endblock %}
{% block topbar_title %}
  {{ tp('topbar_title') }}
  {% if session.active_site_name %}
    ‚Äì {{ session.active_site_name }}
  {% elif current_site_name %}
    ‚Äì {{ current_site_name }}
  {% endif %}
{% endblock %}

{% block content %}

<div class="dashboard-grid">

  <!-- SOL: YENƒ∞ DUYURU -->
  <section>
    <div class="card">
      <h2 style="font-size:16px; margin-bottom:12px;">{{ tp('new_card_title') }}</h2>

      <form method="post" style="display:flex; flex-direction:column; gap:10px;">

        <div>
          <label for="title" style="display:block; font-size:13px; margin-bottom:3px;">{{ tp('label_title') }}</label>
          <input
            type="text"
            id="title"
            name="title"
            required
            placeholder="{{ tp('ph_title') }}"
            style="width:100%; padding:7px 9px; border-radius:8px; border:1px solid #e5e7eb; font-size:13px;">
        </div>

        <div>
          <label for="content" style="display:block; font-size:13px; margin-bottom:3px;">{{ tp('label_content') }}</label>
          <textarea
            id="content"
            name="content"
            rows="4"
            required
            placeholder="{{ tp('ph_content') }}"
            style="width:100%; padding:7px 9px; border-radius:8px; border:1px solid #e5e7eb; font-size:13px; resize:vertical;"></textarea>
        </div>

        <div>
          <label for="target" style="display:block; font-size:13px; margin-bottom:3px;">{{ tp('label_target') }}</label>
          <select
            id="target"
            name="target"
            style="width:100%; padding:7px 9px; border-radius:8px; border:1px solid #e5e7eb; font-size:13px;">
            <option value="all">{{ tp('target_all') }}</option>
            <option value="admins">{{ tp('target_admins') }}</option>
          </select>
        </div>

        <div style="margin-top:4px;">
          <button type="submit"
                  style="padding:8px 12px; border-radius:999px; border:none; background:#2563eb; color:white; font-size:13px; cursor:pointer;">
            {{ tp('btn_publish') }}
          </button>
        </div>

      </form>
    </div>
  </section>

  <!-- SAƒû: DUYURU Lƒ∞STESƒ∞ -->
  <section>
    <div class="card">
      <h2 style="font-size:16px; margin-bottom:10px;">{{ tp('list_title') }}</h2>

      {% if announcements %}
        <ul style="list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:8px;">
          {% for ann, user in announcements %}
            {# üîπ G√ºn√º ge√ßmi≈ü mi? created_at tarihi bug√ºnden k√º√ß√ºkse #}
            {% set is_expired = ann.created_at and (today - ann.created_at.date()).days >= 29 %}

            <li style="padding:8px 10px; border-radius:10px; background:#f9fafb; {% if is_expired %}opacity:0.6;{% endif %}">
              <div style="display:flex; justify-content:space-between; gap:8px; margin-bottom:4px;">
                <div style="font-size:13px; font-weight:600; {% if is_expired %}text-decoration:line-through;{% endif %}">
                  {{ ann.title }}
                </div>
                <div style="font-size:11px; color:#6b7280; white-space:nowrap;">
                  {{ ann.created_at.strftime('%d.%m.%Y %H:%M') if ann.created_at }}
                </div>
              </div>

              <div style="font-size:12px; color:#4b5563; margin-bottom:6px; {% if is_expired %}text-decoration:line-through;{% endif %}">
                {{ ann.content }}
              </div>

              <div style="display:flex; justify-content:space-between; font-size:11px; color:#6b7280;">
                <span>
                  {% if ann.target == "admins" %}
                    {{ tp('target_prefix') }} {{ tp('target_admins_short') }}
                  {% else %}
                    {{ tp('target_prefix') }} {{ tp('target_all_short') }}
                  {% endif %}
                  {% if is_expired %}
                    ¬∑ <span style="font-style:italic;">{{ tp('expired') }}</span>
                  {% endif %}
                </span>
                <span>
                  {% if user %}
                    {{ tp('publisher_prefix') }} {{ user.name }}
                  {% else %}
                    {{ tp('system') }}
                  {% endif %}
                </span>
              </div>
            </li>
          {% endfor %}
        </ul>

      {% else %}
        <p style="font-size:13px; color:#6b7280;">
          {{ tp('empty') }}
        </p>
      {% endif %}
    </div>
  </section>

</div>

{% endblock %}
