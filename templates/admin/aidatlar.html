{% extends "base.html" %}

{# ============================================================
   Aƒ∞DATLAR / BOR√áLAR - 4 Dƒ∞L (TR / EN / ME / RU) UYUMLU
   ============================================================ #}

{% set LANG = session.get('lang','tr') %}

{% set I18N_PAGE = {
  'tr': {
    'page_title': 'Aidatlar / Bor√ßlar',
    'topbar_title': 'Aidatlar / Bor√ßlar',

    'new_record_title': 'Yeni Bor√ß / Aidat Kaydƒ±',
    'apartment': 'Daire',
    'choose_apartment': 'Daire se√ßin...',
    'for_all': 'Bu borcu t√ºm daireler i√ßin olu≈ütur',
    'for_all_hint': 'Eƒüer i≈üaretlerseniz, √ºstteki daire se√ßimi yok sayƒ±lƒ±r ve t√ºm dairelere aynƒ± bor√ß eklenir.',

    'description': 'A√ßƒ±klama',
    'description_ph': '√ñrn: Ocak 2026 Aidatƒ±',

    'amount': 'Tutar (‚Ç∫)',
    'amount_ph': '√ñrn: 750',

    'due_date': 'Vade Tarihi',

    'type_optional': 'T√ºr (opsiyonel)',
    'not_selected': 'Se√ßilmedi',

    'type_aidat': 'Aidat',
    'type_elektrik': 'Elektrik',
    'type_su': 'Su',
    'type_dogalgaz': 'Doƒüalgaz',
    'type_ekstra': 'Ekstra Gider',

    'create_bill': 'Bor√ß Kaydƒ±nƒ± Olu≈ütur',

    'existing_title': 'Mevcut Bor√ß / Aidat Kayƒ±tlarƒ±',
    'filter_status': 'Durum',
    'filter_type': 'T√ºr',
    'filter': 'Filtrele',

    'all': 'Hepsi',
    'status_open': 'A√ßƒ±k',
    'status_partial': 'Kƒ±smi',
    'status_paid': '√ñdendi',

    'col_apartment': 'Daire',
    'col_description': 'A√ßƒ±klama',
    'col_type': 'T√ºr',
    'col_amount': 'Tutar',
    'col_due': 'Vade',
    'col_status': 'Durum',

    'not_specified': 'Belirtilmedi',
    'none': 'Yok',

    'total': 'Toplam',
    'record': 'kayƒ±t',
    'page': 'Sayfa',
    'first': 'ƒ∞lk',
    'prev': '√ñnceki',
    'next': 'Sonraki',
    'last': 'Son',

    'no_bills': 'Hen√ºz kayƒ±tlƒ± bir bor√ß / aidat bulunmuyor. Soldaki formdan ilk kaydƒ± ekleyebilirsiniz.',

    'apartment_summary_title': 'Daire Bazƒ±nda Toplam Bor√ß √ñzeti',
    'debt_types': 'Bor√ß T√ºrleri',
    'total_col': 'Toplam',
    'paid_col': '√ñdenen',
    'remaining_col': 'Kalan',
    'no_summary': 'Hen√ºz √∂zetlenecek bor√ß kaydƒ± bulunmuyor.'
  },

  'en': {
    'page_title': 'Dues / Bills',
    'topbar_title': 'Dues / Bills',

    'new_record_title': 'New Bill / Dues Record',
    'apartment': 'Apartment',
    'choose_apartment': 'Select an apartment...',
    'for_all': 'Create this bill for all apartments',
    'for_all_hint': 'If checked, the apartment selection above is ignored and the same bill is added to all apartments.',

    'description': 'Description',
    'description_ph': 'e.g., January 2026 Dues',

    'amount': 'Amount (‚Ç∫)',
    'amount_ph': 'e.g., 750',

    'due_date': 'Due Date',

    'type_optional': 'Type (optional)',
    'not_selected': 'Not selected',

    'type_aidat': 'Dues',
    'type_elektrik': 'Electricity',
    'type_su': 'Water',
    'type_dogalgaz': 'Natural Gas',
    'type_ekstra': 'Extra Expense',

    'create_bill': 'Create Bill',

    'existing_title': 'Existing Bill / Dues Records',
    'filter_status': 'Status',
    'filter_type': 'Type',
    'filter': 'Filter',

    'all': 'All',
    'status_open': 'Open',
    'status_partial': 'Partial',
    'status_paid': 'Paid',

    'col_apartment': 'Apartment',
    'col_description': 'Description',
    'col_type': 'Type',
    'col_amount': 'Amount',
    'col_due': 'Due',
    'col_status': 'Status',

    'not_specified': 'Not specified',
    'none': 'None',

    'total': 'Total',
    'record': 'records',
    'page': 'Page',
    'first': 'First',
    'prev': 'Previous',
    'next': 'Next',
    'last': 'Last',

    'no_bills': 'No bill/dues records yet. You can add the first record using the form on the left.',

    'apartment_summary_title': 'Apartment-Based Total Debt Summary',
    'debt_types': 'Debt Types',
    'total_col': 'Total',
    'paid_col': 'Paid',
    'remaining_col': 'Remaining',
    'no_summary': 'No bills to summarize yet.'
  },

  'me': {
    'page_title': 'ƒålanarine / Dugovanja',
    'topbar_title': 'ƒålanarine / Dugovanja',

    'new_record_title': 'Novi zapis dugovanja / ƒçlanarine',
    'apartment': 'Stan',
    'choose_apartment': 'Izaberite stan...',
    'for_all': 'Kreiraj ovo dugovanje za sve stanove',
    'for_all_hint': 'Ako je oznaƒçeno, izbor stana iznad se ignori≈°e i isto dugovanje se dodaje svim stanovima.',

    'description': 'Opis',
    'description_ph': 'npr. ƒålanarina januar 2026',

    'amount': 'Iznos (‚Ç∫)',
    'amount_ph': 'npr. 750',

    'due_date': 'Rok dospijeƒáa',

    'type_optional': 'Tip (opciono)',
    'not_selected': 'Nije izabrano',

    'type_aidat': 'ƒålanarina',
    'type_elektrik': 'Struja',
    'type_su': 'Voda',
    'type_dogalgaz': 'Gas',
    'type_ekstra': 'Dodatni tro≈°ak',

    'create_bill': 'Kreiraj dugovanje',

    'existing_title': 'Postojeƒái zapisi dugovanja / ƒçlanarine',
    'filter_status': 'Status',
    'filter_type': 'Tip',
    'filter': 'Filtriraj',

    'all': 'Svi',
    'status_open': 'Otvoreno',
    'status_partial': 'Djelimiƒçno',
    'status_paid': 'Plaƒáeno',

    'col_apartment': 'Stan',
    'col_description': 'Opis',
    'col_type': 'Tip',
    'col_amount': 'Iznos',
    'col_due': 'Rok',
    'col_status': 'Status',

    'not_specified': 'Nije navedeno',
    'none': 'Nema',

    'total': 'Ukupno',
    'record': 'zapisa',
    'page': 'Strana',
    'first': 'Prva',
    'prev': 'Prethodna',
    'next': 'Sledeƒáa',
    'last': 'Poslednja',

    'no_bills': 'Jo≈° nema zapisa dugovanja/ƒçlanarine. Prvi zapis mo≈æete dodati putem forme lijevo.',

    'apartment_summary_title': 'Sa≈æetak ukupnog duga po stanovima',
    'debt_types': 'Tipovi duga',
    'total_col': 'Ukupno',
    'paid_col': 'Plaƒáeno',
    'remaining_col': 'Preostalo',
    'no_summary': 'Jo≈° nema dugovanja za sa≈æetak.'
  },

  'ru': {
    'page_title': '–í–∑–Ω–æ—Å—ã / –î–æ–ª–≥–∏',
    'topbar_title': '–í–∑–Ω–æ—Å—ã / –î–æ–ª–≥–∏',

    'new_record_title': '–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å –¥–æ–ª–≥–∞ / –≤–∑–Ω–æ—Å–∞',
    'apartment': '–ö–≤–∞—Ä—Ç–∏—Ä–∞',
    'choose_apartment': '–í—ã–±–µ—Ä–∏—Ç–µ –∫–≤–∞—Ä—Ç–∏—Ä—É...',
    'for_all': '–°–æ–∑–¥–∞—Ç—å —ç—Ç–æ—Ç –¥–æ–ª–≥ –¥–ª—è –≤—Å–µ—Ö –∫–≤–∞—Ä—Ç–∏—Ä',
    'for_all_hint': '–ï—Å–ª–∏ –æ—Ç–º–µ—á–µ–Ω–æ, –≤—ã–±–æ—Ä –∫–≤–∞—Ä—Ç–∏—Ä—ã –≤—ã—à–µ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è, –∏ –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –¥–æ–ª–≥ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤—Å–µ–º –∫–≤–∞—Ä—Ç–∏—Ä–∞–º.',

    'description': '–û–ø–∏—Å–∞–Ω–∏–µ',
    'description_ph': '–ù–∞–ø—Ä.: –í–∑–Ω–æ—Å –∑–∞ —è–Ω–≤–∞—Ä—å 2026',

    'amount': '–°—É–º–º–∞ (‚Ç∫)',
    'amount_ph': '–ù–∞–ø—Ä.: 750',

    'due_date': '–°—Ä–æ–∫ –æ–ø–ª–∞—Ç—ã',

    'type_optional': '–¢–∏–ø (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)',
    'not_selected': '–ù–µ –≤—ã–±—Ä–∞–Ω–æ',

    'type_aidat': '–í–∑–Ω–æ—Å',
    'type_elektrik': '–≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ',
    'type_su': '–í–æ–¥–∞',
    'type_dogalgaz': '–ü—Ä–∏—Ä–æ–¥–Ω—ã–π –≥–∞–∑',
    'type_ekstra': '–î–æ–ø. —Ä–∞—Å—Ö–æ–¥',

    'create_bill': '–°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å –¥–æ–ª–≥–∞',

    'existing_title': '–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–ø–∏—Å–∏ –¥–æ–ª–≥–æ–≤ / –≤–∑–Ω–æ—Å–æ–≤',
    'filter_status': '–°—Ç–∞—Ç—É—Å',
    'filter_type': '–¢–∏–ø',
    'filter': '–§–∏–ª—å—Ç—Ä',

    'all': '–í—Å–µ',
    'status_open': '–û—Ç–∫—Ä—ã—Ç–æ',
    'status_partial': '–ß–∞—Å—Ç–∏—á–Ω–æ',
    'status_paid': '–û–ø–ª–∞—á–µ–Ω–æ',

    'col_apartment': '–ö–≤–∞—Ä—Ç–∏—Ä–∞',
    'col_description': '–û–ø–∏—Å–∞–Ω–∏–µ',
    'col_type': '–¢–∏–ø',
    'col_amount': '–°—É–º–º–∞',
    'col_due': '–°—Ä–æ–∫',
    'col_status': '–°—Ç–∞—Ç—É—Å',

    'not_specified': '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
    'none': '–ù–µ—Ç',

    'total': '–í—Å–µ–≥–æ',
    'record': '–∑–∞–ø–∏—Å–µ–π',
    'page': '–°—Ç—Ä–∞–Ω–∏—Ü–∞',
    'first': '–ü–µ—Ä–≤–∞—è',
    'prev': '–ü—Ä–µ–¥—ã–¥—É—â–∞—è',
    'next': '–°–ª–µ–¥—É—é—â–∞—è',
    'last': '–ü–æ—Å–ª–µ–¥–Ω—è—è',

    'no_bills': '–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π –¥–æ–ª–≥–æ–≤/–≤–∑–Ω–æ—Å–æ–≤. –í—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—É—é –∑–∞–ø–∏—Å—å —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º—É —Å–ª–µ–≤–∞.',

    'apartment_summary_title': '–°–≤–æ–¥–∫–∞ –æ–±—â–µ–≥–æ –¥–æ–ª–≥–∞ –ø–æ –∫–≤–∞—Ä—Ç–∏—Ä–∞–º',
    'debt_types': '–¢–∏–ø—ã –¥–æ–ª–≥–æ–≤',
    'total_col': '–ò—Ç–æ–≥–æ',
    'paid_col': '–û–ø–ª–∞—á–µ–Ω–æ',
    'remaining_col': '–û—Å—Ç–∞—Ç–æ–∫',
    'no_summary': '–ü–æ–∫–∞ –Ω–µ—Ç –¥–æ–ª–≥–æ–≤ –¥–ª—è —Å–≤–æ–¥–∫–∏.'
  }
} %}

{% macro tp(k) -%}
  {{ I18N_PAGE.get(LANG, I18N_PAGE['tr']).get(k, I18N_PAGE['tr'].get(k, k)) }}
{%- endmacro %}

{# Tip √ßevirileri (ekran i√ßin) #}
{% set TYPE_LABEL = {
  'tr': {'aidat':'Aidat','elektrik':'Elektrik','su':'Su','dogalgaz':'Doƒüalgaz','ekstra':'Ekstra Gider'},
  'en': {'aidat':'Dues','elektrik':'Electricity','su':'Water','dogalgaz':'Natural Gas','ekstra':'Extra Expense'},
  'me': {'aidat':'ƒålanarina','elektrik':'Struja','su':'Voda','dogalgaz':'Gas','ekstra':'Dodatni tro≈°ak'},
  'ru': {'aidat':'–í–∑–Ω–æ—Å','elektrik':'–≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ','su':'–í–æ–¥–∞','dogalgaz':'–ü—Ä–∏—Ä–æ–¥–Ω—ã–π –≥–∞–∑','ekstra':'–î–æ–ø. —Ä–∞—Å—Ö–æ–¥'}
} %}

{% block title %}{{ tp('page_title') }}{% endblock %}
{% block topbar_title %}
  {{ tp('topbar_title') }}
  {% if session.active_site_name %}
    ‚Äì {{ session.active_site_name }}
  {% elif current_site_name %}
    ‚Äì {{ current_site_name }}
  {% endif %}
{% endblock %}

{% block content %}

<div class="dashboard-grid">

  <!-- SOL: YENƒ∞ BOR√á / Aƒ∞DAT EKLE -->
  <section>
    <div class="card">
      <h2 style="font-size:16px; margin-bottom:12px;">{{ tp('new_record_title') }}</h2>

      <form method="post" style="display:flex; flex-direction:column; gap:10px;">

        <div>
          <label for="apartment_id" style="display:block; font-size:13px; margin-bottom:3px;">{{ tp('apartment') }}</label>
          <select
            id="apartment_id"
            name="apartment_id"
            style="width:100%; padding:7px 9px; border-radius:8px; border:1px solid #e5e7eb; font-size:13px;">
            <option value="">{{ tp('choose_apartment') }}</option>
            {% for apt in apartments %}
              <option value="{{ apt.id }}">
                {{ apt.block }} Blok ‚Ä¢ Kat {{ apt.floor }} ‚Ä¢ No {{ apt.number }}
              </option>
            {% endfor %}
          </select>

          <!-- ‚úÖ T√ºm daireler i√ßin bor√ß -->
          <label style="display:flex; align-items:center; gap:6px; margin-top:6px; font-size:12px; color:#4b5563;">
            <input type="checkbox" id="for_all" name="for_all" value="1">
            {{ tp('for_all') }}
          </label>
          <p style="font-size:11px; color:#9ca3af; margin-top:2px;">
            {{ tp('for_all_hint') }}
          </p>
        </div>

        <div>
          <label for="description" style="display:block; font-size:13px; margin-bottom:3px;">{{ tp('description') }}</label>
          <input
            type="text"
            id="description"
            name="description"
            required
            placeholder="{{ tp('description_ph') }}"
            style="width:100%; padding:7px 9px; border-radius:8px; border:1px solid #e5e7eb; font-size:13px;">
        </div>

        <div style="display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px;">
          <div>
            <label for="amount" style="display:block; font-size:13px; margin-bottom:3px;">{{ tp('amount') }}</label>
            <input
              type="text"
              id="amount"
              name="amount"
              required
              placeholder="{{ tp('amount_ph') }}"
              style="width:100%; padding:7px 9px; border-radius:8px; border:1px solid #e5e7eb; font-size:13px;">
          </div>

          <div>
            <label for="due_date" style="display:block; font-size:13px; margin-bottom:3px;">{{ tp('due_date') }}</label>
            <input
              type="date"
              id="due_date"
              name="due_date"
              style="width:100%; padding:7px 9px; border-radius:8px; border:1px solid #e5e7eb; font-size:13px;">
          </div>
        </div>

        <div>
          <label for="type" style="display:block; font-size:13px; margin-bottom:3px;">{{ tp('type_optional') }}</label>
          <select
            id="type"
            name="type"
            style="width:100%; padding:7px 9px; border-radius:8px; border:1px solid #e5e7eb; font-size:13px;">
            <option value="">{{ tp('not_selected') }}</option>
            <option value="aidat">{{ tp('type_aidat') }}</option>
            <option value="elektrik">{{ tp('type_elektrik') }}</option>
            <option value="su">{{ tp('type_su') }}</option>
            <option value="dogalgaz">{{ tp('type_dogalgaz') }}</option>
            <option value="ekstra">{{ tp('type_ekstra') }}</option>
          </select>
        </div>

        <div style="margin-top:4px;">
          <button type="submit"
                  style="padding:8px 12px; border-radius:999px; border:none; background:#2563eb; color:white; font-size:13px; cursor:pointer;">
            {{ tp('create_bill') }}
          </button>
        </div>

      </form>
    </div>
  </section>

  <!-- SAƒû: BOR√á / Aƒ∞DAT Lƒ∞STESƒ∞ + √ñZET -->
  <section>
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <h2 style="font-size:16px;">{{ tp('existing_title') }}</h2>

        <!-- üîé Filtre Formu -->
        <form method="get" style="display:flex; gap:6px; align-items:center; font-size:11px;">
          <input type="hidden" name="sort" value="{{ current_sort }}">
          <input type="hidden" name="dir" value="{{ current_dir }}">

          <label style="color:#6b7280;">{{ tp('filter_status') }}</label>
          <select name="status"
                  style="padding:4px 6px; border-radius:999px; border:1px solid #e5e7eb; font-size:11px;">
            <option value="" {{ '' == filter_status and 'selected' or '' }}>{{ tp('all') }}</option>
            <option value="open" {{ filter_status == 'open' and 'selected' or '' }}>{{ tp('status_open') }}</option>
            <option value="partial" {{ filter_status == 'partial' and 'selected' or '' }}>{{ tp('status_partial') }}</option>
            <option value="paid" {{ filter_status == 'paid' and 'selected' or '' }}>{{ tp('status_paid') }}</option>
          </select>

          <label style="color:#6b7280;">{{ tp('filter_type') }}</label>
          <select name="bill_type"
                  style="padding:4px 6px; border-radius:999px; border:1px solid #e5e7eb; font-size:11px;">
            <option value="" {{ '' == filter_type and 'selected' or '' }}>{{ tp('all') }}</option>
            <option value="aidat" {{ filter_type == 'aidat' and 'selected' or '' }}>{{ tp('type_aidat') }}</option>
            <option value="elektrik" {{ filter_type == 'elektrik' and 'selected' or '' }}>{{ tp('type_elektrik') }}</option>
            <option value="su" {{ filter_type == 'su' and 'selected' or '' }}>{{ tp('type_su') }}</option>
            <option value="dogalgaz" {{ filter_type == 'dogalgaz' and 'selected' or '' }}>{{ tp('type_dogalgaz') }}</option>
            <option value="ekstra" {{ filter_type == 'ekstra' and 'selected' or '' }}>{{ tp('type_ekstra') }}</option>
          </select>

          <button type="submit"
                  style="padding:4px 10px; border-radius:999px; border:none; background:#2563eb; color:white; cursor:pointer;">
            {{ tp('filter') }}
          </button>
        </form>
      </div>

      {% if bills %}
        <div style="width:100%; overflow-x:auto;">
          <table style="width:100%; border-collapse:collapse; font-size:12px;">
            <thead>
              <tr style="background:#f9fafb; border-bottom:1px solid #e5e7eb;">

                {# Ba≈ülƒ±klara tƒ±klayƒ±nca sƒ±ralama #}
                {% macro sort_link(label, field) %}
                  {%- set is_current = (current_sort == field) -%}
                  {%- set next_dir = 'asc' if (not is_current or current_dir == 'desc') else 'desc' -%}
                  <a href="{{ url_for('admin.manage_bills',
                                      sort=field,
                                      dir=next_dir,
                                      page=1,
                                      status=filter_status,
                                      bill_type=filter_type) }}"
                     style="color:inherit; text-decoration:none; display:inline-flex; align-items:center; gap:3px;">
                    <span>{{ label }}</span>
                    {% if is_current %}
                      <span style="font-size:10px;">{{ '‚ñ≤' if current_dir == 'asc' else '‚ñº' }}</span>
                    {% endif %}
                  </a>
                {% endmacro %}

                <th style="text-align:left; padding:6px 4px;">
                  {{ sort_link(tp('col_apartment'), 'apartment') }}
                </th>
                <th style="text-align:left; padding:6px 4px;">
                  {{ sort_link(tp('col_description'), 'description') }}
                </th>
                <th style="text-align:left; padding:6px 4px;">
                  {{ sort_link(tp('col_type'), 'type') }}
                </th>
                <th style="text-align:left; padding:6px 4px;">
                  {{ sort_link(tp('col_amount'), 'amount') }}
                </th>
                <th style="text-align:left; padding:6px 4px;">
                  {{ sort_link(tp('col_due'), 'due_date') }}
                </th>
                <th style="text-align:left; padding:6px 4px;">
                  {{ sort_link(tp('col_status'), 'status') }}
                </th>
              </tr>
            </thead>
            <tbody>
              {% for bill, apt in bills %}
                <tr style="border-bottom:1px solid #f3f4f6;">
                  <td style="padding:6px 4px; white-space:nowrap;">
                    {{ apt.block }} Blok ‚Ä¢ {{ apt.floor }}/{{ apt.number }}
                  </td>
                  <td style="padding:6px 4px;">
                    {{ bill.description }}
                  </td>
                  <td style="padding:6px 4px; white-space:nowrap;">
                    {% if bill.type %}
                      {{ TYPE_LABEL.get(LANG, TYPE_LABEL['tr']).get(bill.type, bill.type) }}
                    {% else %}
                      <span style="color:#9ca3af;">{{ tp('not_specified') }}</span>
                    {% endif %}
                  </td>
                  <td style="padding:6px 4px; white-space:nowrap;">
                    ‚Ç∫ {{ "%.2f"|format(bill.amount) }}
                  </td>
                  <td style="padding:6px 4px; white-space:nowrap;">
                    {% if bill.due_date %}
                      {{ bill.due_date.strftime('%d.%m.%Y') }}
                    {% else %}
                      <span style="color:#9ca3af;">{{ tp('none') }}</span>
                    {% endif %}
                  </td>
                  <td style="padding:6px 4px; white-space:nowrap;">
                    {% if bill.status == 'paid' %}
                      <span style="padding:2px 8px; border-radius:999px; background:#dcfce7; color:#15803d;">{{ tp('status_paid') }}</span>
                    {% elif bill.status == 'partial' %}
                      <span style="padding:2px 8px; border-radius:999px; background:#fef9c3; color:#854d0e;">{{ tp('status_partial') }}</span>
                    {% else %}
                      <span style="padding:2px 8px; border-radius:999px; background:#fee2e2; color:#b91c1c;">{{ tp('status_open') }}</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- üìÑ Sayfalama -->
        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px; font-size:12px; color:#6b7280;">
          <div>
            {{ tp('total') }} {{ total_bills }} {{ tp('record') }} ‚Ä¢
            {{ tp('page') }} {{ page }} / {{ pages }}
          </div>
          <div style="display:flex; gap:4px;">
            {% if page > 1 %}
              <a href="{{ url_for('admin.manage_bills',
                                  page=1,
                                  sort=current_sort,
                                  dir=current_dir,
                                  status=filter_status,
                                  bill_type=filter_type) }}"
                 style="padding:3px 8px; border-radius:999px; border:1px solid #e5e7eb; text-decoration:none; color:#374151;">
                {{ tp('first') }}
              </a>
              <a href="{{ url_for('admin.manage_bills',
                                  page=page-1,
                                  sort=current_sort,
                                  dir=current_dir,
                                  status=filter_status,
                                  bill_type=filter_type) }}"
                 style="padding:3px 8px; border-radius:999px; border:1px solid #e5e7eb; text-decoration:none; color:#374151;">
                {{ tp('prev') }}
              </a>
            {% endif %}

            {% if page < pages %}
              <a href="{{ url_for('admin.manage_bills',
                                  page=page+1,
                                  sort=current_sort,
                                  dir=current_dir,
                                  status=filter_status,
                                  bill_type=filter_type) }}"
                 style="padding:3px 8px; border-radius:999px; border:1px solid #e5e7eb; text-decoration:none; color:#374151;">
                {{ tp('next') }}
              </a>
              <a href="{{ url_for('admin.manage_bills',
                                  page=pages,
                                  sort=current_sort,
                                  dir=current_dir,
                                  status=filter_status,
                                  bill_type=filter_type) }}"
                 style="padding:3px 8px; border-radius:999px; border:1px solid #e5e7eb; text-decoration:none; color:#374151;">
                {{ tp('last') }}
              </a>
            {% endif %}
          </div>
        </div>
      {% else %}
        <p style="font-size:13px; color:#6b7280;">
          {{ tp('no_bills') }}
        </p>
      {% endif %}
    </div>


    <!-- ‚úÖ DAƒ∞RE BAZINDA TOPLAM BOR√á √ñZETƒ∞ -->
    <div class="card">
      <h2 style="font-size:16px; margin-bottom:10px;">{{ tp('apartment_summary_title') }}</h2>

      {% if apartment_summaries %}
        <div style="width:100%; overflow-x:auto;">
          <table style="width:100%; border-collapse:separate; border-spacing:0 6px; font-size:12px;">
            <thead>
              <tr style="background:#f9fafb;">
                <th style="text-align:left; padding:6px 8px;">{{ tp('col_apartment') }}</th>
                <th style="text-align:center; padding:6px 8px;">{{ tp('debt_types') }}</th>
                <th style="text-align:right; padding:6px 8px;">{{ tp('total_col') }}</th>
                <th style="text-align:right; padding:6px 8px;">{{ tp('paid_col') }}</th>
                <th style="text-align:right; padding:6px 8px;">{{ tp('remaining_col') }}</th>
              </tr>
            </thead>

            <tbody>
              {% for row in apartment_summaries %}
                {% set has_debt = row.remaining > 0 %}
                <tr>
                  <td colspan="5" style="padding:0;">
                    <div style="
                      display:grid;
                      grid-template-columns: 1.2fr 2fr 1fr 1fr 1fr;
                      padding:8px 10px;
                      border-radius:12px;
                      border:1px solid {{ '#fee2e2' if has_debt else '#dcfce7' }};
                      background:{{ '#fef2f2' if has_debt else '#f0fdf4' }};
                    ">

                      <!-- Daire -->
                      <div style="font-weight:600;">
                        {{ row.apartment.block }} Blok ‚Ä¢ {{ row.apartment.floor }}/{{ row.apartment.number }}
                      </div>

                      <!-- üîπ T√ºr + Tutar listesi -->
                      <div style="display:flex; flex-wrap:wrap; gap:6px;">
                        {% for t,val in row.type_totals.items() %}
                          <span style="
                            padding:3px 8px;
                            border-radius:999px;
                            background:white;
                            border:1px solid #e5e7eb;
                            font-size:11px;
                          ">
                            {{ TYPE_LABEL.get(LANG, TYPE_LABEL['tr']).get(t, t) }}: ‚Ç∫ {{ "%.2f"|format(val) }}
                          </span>
                        {% endfor %}
                      </div>

                      <!-- Toplam -->
                      <div style="text-align:right;">
                        ‚Ç∫ {{ "%.2f"|format(row.total_debt) }}
                      </div>

                      <!-- √ñdenen -->
                      <div style="text-align:right; color:#16a34a;">
                        ‚Ç∫ {{ "%.2f"|format(row.total_paid) }}
                      </div>

                      <!-- Kalan -->
                      <div style="text-align:right; color:{{ '#b91c1c' if has_debt else '#15803d' }};">
                        ‚Ç∫ {{ "%.2f"|format(row.remaining) }}
                      </div>

                    </div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>

          </table>
        </div>
      {% else %}
        <p style="font-size:13px; color:#6b7280;">
          {{ tp('no_summary') }}
        </p>
      {% endif %}
    </div>

  </section>

</div>

<!-- ‚úÖ Checkbox i≈üaretliyken daire se√ßimini devre dƒ±≈üƒ± bƒ±rak -->
<script>
  (function () {
    const checkbox = document.getElementById('for_all');
    const select = document.getElementById('apartment_id');
    if (!checkbox || !select) return;

    function sync() {
      if (checkbox.checked) {
        select.value = '';
        select.disabled = true;
      } else {
        select.disabled = false;
      }
    }

    checkbox.addEventListener('change', sync);
    // Sayfa y√ºklenince ilk durumu ayarla
    sync();
  })();
</script>

<script>
  // Satƒ±rƒ± "view" moddan "edit" moda al
  function enterEditMode(rowId) {
    const row = document.querySelector(`.bill-row[data-row-id="${rowId}"]`);
    if (!row) return;

    row.classList.add("editing");

    // Inputlarƒ± aktif et
    row.querySelectorAll(".bill-input-text").forEach(inp => {
      inp.readOnly = false;
      inp.style.border = "1px solid #e5e7eb";
      inp.style.background = "#ffffff";
    });

    row.querySelectorAll(".bill-input-select").forEach(sel => {
      sel.disabled = false;
      sel.style.border = "1px solid #e5e7eb";
      sel.style.background = "#ffffff";
    });

    // Buton g√∂r√ºn√ºrl√ºkleri
    const btnEdit = row.querySelector(".btn-bill-edit");
    const btnSave = row.querySelector(".btn-bill-save");
    const btnCancel = row.querySelector(".btn-bill-cancel");

    if (btnEdit) btnEdit.style.display = "none";
    if (btnSave) btnSave.style.display = "inline-block";
    if (btnCancel) btnCancel.style.display = "inline-block";

    // Eski deƒüerleri data-* olarak sakla (Vazge√ß i√ßin)
    row.querySelectorAll(".bill-input").forEach(inp => {
      inp.dataset.originalValue = inp.value;
    });
  }

  // Satƒ±rƒ± tekrar "view" moda al ve deƒüi≈üiklikleri geri al (Vazge√ß)
  function cancelEditMode(rowId) {
    const row = document.querySelector(`.bill-row[data-row-id="${rowId}"]`);
    if (!row) return;

    row.classList.remove("editing");

    row.querySelectorAll(".bill-input").forEach(inp => {
      if (inp.dataset.originalValue !== undefined) {
        inp.value = inp.dataset.originalValue;
      }
      if (inp.classList.contains("bill-input-text")) {
        inp.readOnly = true;
        inp.style.border = "none";
        inp.style.background = "transparent";
      }
      if (inp.classList.contains("bill-input-select")) {
        inp.disabled = true;
        inp.style.border = "none";
        inp.style.background = "transparent";
      }
    });

    const btnEdit = row.querySelector(".btn-bill-edit");
    const btnSave = row.querySelector(".btn-bill-save");
    const btnCancel = row.querySelector(".btn-bill-cancel");

    if (btnEdit) btnEdit.style.display = "inline-block";
    if (btnSave) btnSave.style.display = "none";
    if (btnCancel) btnCancel.style.display = "none";
  }

  // Girilen tarihleri normalize et (1.1.2026 / 01-01-2026 / 2026/1/1 ‚Üí 2026-01-01)
  function normalizeDateString(text) {
    if (!text) return "";

    const raw = text.trim();

    // Zaten 2026-01-05 gibi ise dokunma
    if (/^\d{4}-\d{2}-\d{2}$/.test(raw)) {
      return raw;
    }

    // GG.AA.YYYY veya GG/AA/YYYY veya GG-AA-YYYY
    let m = raw.match(/^(\d{1,2})[.\-\/](\d{1,2})[.\-\/](\d{2,4})$/);
    if (m) {
      let d = m[1].padStart(2, "0");
      let mo = m[2].padStart(2, "0");
      let y = m[3];
      if (y.length === 2) {
        // 2 haneli yƒ±l gelirse 20xx varsayƒ±mƒ±
        y = "20" + y;
      }
      return `${y}-${mo}-${d}`;
    }

    // YYYY/MM/DD veya YYYY.MM.DD
    m = raw.match(/^(\d{4})[.\-\/](\d{1,2})[.\-\/](\d{1,2})$/);
    if (m) {
      let y = m[1];
      let mo = m[2].padStart(2, "0");
      let d = m[3].padStart(2, "0");
      return `${y}-${mo}-${d}`;
    }

    // Hi√ßbirine uymuyorsa olduƒüu gibi d√∂n (backend de tekrar deneyecek)
    return raw;
  }

  // Form g√∂nderilmeden √∂nce tarih input'unu normalize et
  function attachFormHandlers() {
    document.querySelectorAll(".bill-edit-form").forEach(form => {
      form.addEventListener("submit", function (e) {
        const row = form.closest(".bill-row");
        if (!row) return;

        const dateInput = row.querySelector(".bill-input-date");
        if (dateInput) {
          const normalized = normalizeDateString(dateInput.value);
          dateInput.value = normalized;
        }
      });
    });
  }

  // Event binding
  document.addEventListener("DOMContentLoaded", function () {
    // D√ºzenle butonlarƒ±
    document.querySelectorAll(".btn-bill-edit").forEach(btn => {
      btn.addEventListener("click", function () {
        const rowId = btn.dataset.rowId;
        enterEditMode(rowId);
      });
    });

    // Vazge√ß butonlarƒ±
    document.querySelectorAll(".btn-bill-cancel").forEach(btn => {
      btn.addEventListener("click", function () {
        const rowId = btn.dataset.rowId;
        cancelEditMode(rowId);
      });
    });

    attachFormHandlers();
  });
</script>

{% endblock %}
