{% extends "base.html" %}

{# ============================================================
   DASHBOARD - 4 DİL (TR / EN / ME / RU) UYUMLU
   ============================================================ #}

{% set LANG = session.get('lang','tr') %}

{% set I18N_PAGE = {
  'tr': {
    'page_title': 'Yönetim Paneli',
    'topbar_title': 'Yönetim Ana Paneli',
    'general_summary': 'Genel Özet',
    'general_summary_desc': 'Siteye ait daire, kullanıcı, borç ve talep durumunun kısa özeti.',
    'total_apartments': 'Toplam Daire',
    'users': 'Kullanıcılar',
    'admin': 'Yönetici',
    'resident': 'Sakin',
    'open_partial_debt': 'Açık / Kısmi Borç',
    'total_bill_records': 'Toplam borç kaydı',
    'total_paid': 'Toplam Ödenmiş',
    'expected_income_this_month': 'Bu Ay Beklenen Toplam Gelir',
    'expected_income_hint': 'Bu ay açılan tüm borç kayıtlarının toplamı',
    'open_tickets': 'Açık Talepler',
    'view_all_tickets': 'Tüm talepleri görüntüle →',
    'monthly_overview_title': 'Aylık Özet (Son 12 Ay)',
    'monthly_overview_desc': 'Her ay için oluşturulan toplam borç ve tahsil edilen toplam ödeme.',
    'year_total': 'Yıl Geneli',
    'selected_period': 'Seçili dönem',
    'billed': 'Oluşturulan borç',
    'collected': 'Tahsil edilen',
    'delta': 'Fark',
    'table_month': 'Ay',
    'table_billed': 'Oluşturulan Borç',
    'table_paid': 'Tahsil Edilen',
    'table_delta': 'Fark',
    'not_enough_data': 'Henüz aylık özet oluşturmak için yeterli veri bulunmuyor.',
    'recent_bills': 'Son Eklenen Borçlar',
    'bill_apartment': 'Daire',
    'bill_desc': 'Açıklama',
    'bill_amount': 'Tutar',
    'bill_status': 'Durum',
    'status_paid': 'Ödendi',
    'status_partial': 'Kısmi',
    'status_open': 'Açık',
    'no_bills': 'Henüz borç kaydı bulunmuyor.',
    'recent_payments': 'Son Ödemeler',
    'pay_date': 'Tarih',
    'pay_resident': 'Sakin',
    'pay_amount': 'Tutar',
    'pay_method': 'Yöntem',
    'no_payments': 'Henüz ödeme kaydı bulunmuyor.',
    'recent_tickets': 'Son Talepler',
    'ticket_title': 'Başlık',
    'ticket_status': 'Durum',
    'ticket_closed': 'Kapalı',
    'ticket_in_progress': 'Devam',
    'ticket_open': 'Açık',
    'no_tickets': 'Henüz talep oluşturulmamış.',
    'carryover_amount': 'Önceki Aylardan Devir Eden',
    'carryover_hint': 'Bu aydan önceki borçların ödenmemiş kalan toplamı',
    'recent_announcements': 'Son Duyurular',
    'created_by': 'Oluşturan',
    'unknown': 'Bilinmiyor',
    'expired': 'Süresi doldu',
    'no_announcements': 'Henüz bir duyuru oluşturulmamış.'
  },
  'en': {
    'page_title': 'Management Panel',
    'topbar_title': 'Admin Dashboard',
    'general_summary': 'General Summary',
    'general_summary_desc': 'A quick overview of apartments, users, debts, and requests.',
    'total_apartments': 'Total Apartments',
    'users': 'Users',
    'admin': 'Admin',
    'resident': 'Resident',
    'open_partial_debt': 'Open / Partial Debt',
    'total_bill_records': 'Total bill records',
    'total_paid': 'Total Paid',
    'expected_income_this_month': 'Expected Income This Month',
    'expected_income_hint': 'Sum of all bills created this month',
    'open_tickets': 'Open Requests',
    'view_all_tickets': 'View all requests →',
    'monthly_overview_title': 'Monthly Overview (Last 12 Months)',
    'monthly_overview_desc': 'Total billed and total collected for each month.',
    'year_total': 'Year Total',
    'selected_period': 'Selected period',
    'billed': 'Billed',
    'collected': 'Collected',
    'delta': 'Difference',
    'table_month': 'Month',
    'table_billed': 'Billed',
    'table_paid': 'Collected',
    'table_delta': 'Difference',
    'not_enough_data': 'Not enough data yet to generate the monthly overview.',
    'recent_bills': 'Recently Added Bills',
    'bill_apartment': 'Apartment',
    'bill_desc': 'Description',
    'bill_amount': 'Amount',
    'bill_status': 'Status',
    'status_paid': 'Paid',
    'status_partial': 'Partial',
    'status_open': 'Open',
    'no_bills': 'No bill records yet.',
    'recent_payments': 'Recent Payments',
    'pay_date': 'Date',
    'pay_resident': 'Resident',
    'pay_amount': 'Amount',
    'pay_method': 'Method',
    'no_payments': 'No payment records yet.',
    'recent_tickets': 'Recent Requests',
    'ticket_title': 'Title',
    'ticket_status': 'Status',
    'ticket_closed': 'Closed',
    'ticket_in_progress': 'In progress',
    'ticket_open': 'Open',
    'no_tickets': 'No requests have been created yet.',
    'carryover_amount': 'Carryover from Previous Months',
    'carryover_hint': 'Total unpaid remaining amount from bills before this month',
    'recent_announcements': 'Recent Announcements',
    'created_by': 'Created by',
    'unknown': 'Unknown',
    'expired': 'Expired',
    'no_announcements': 'No announcements yet.'
  },
  'me': {
    'page_title': 'Upravljački panel',
    'topbar_title': 'Administratorska tabla',
    'general_summary': 'Opšti pregled',
    'general_summary_desc': 'Kratak pregled stanova, korisnika, dugovanja i zahtjeva.',
    'total_apartments': 'Ukupno stanova',
    'users': 'Korisnici',
    'admin': 'Administrator',
    'resident': 'Stanar',
    'open_partial_debt': 'Otvoren / Djelimičan dug',
    'total_bill_records': 'Ukupno evidencija dugovanja',
    'total_paid': 'Ukupno uplaćeno',
    'expected_income_this_month': 'Očekivani prihod ovog mjeseca',
    'expected_income_hint': 'Zbir svih dugovanja otvorenih ovog mjeseca',
    'open_tickets': 'Otvoreni zahtjevi',
    'view_all_tickets': 'Prikaži sve zahtjeve →',
    'monthly_overview_title': 'Mjesečni pregled (poslednjih 12 mjeseci)',
    'monthly_overview_desc': 'Ukupno zaduženo i ukupno naplaćeno za svaki mjesec.',
    'year_total': 'Godišnji zbir',
    'selected_period': 'Izabrani period',
    'billed': 'Zaduženo',
    'collected': 'Naplaćeno',
    'delta': 'Razlika',
    'table_month': 'Mjesec',
    'table_billed': 'Zaduženo',
    'table_paid': 'Naplaćeno',
    'table_delta': 'Razlika',
    'not_enough_data': 'Još nema dovoljno podataka za mjesečni pregled.',
    'recent_bills': 'Najnovija dugovanja',
    'bill_apartment': 'Stan',
    'bill_desc': 'Opis',
    'bill_amount': 'Iznos',
    'bill_status': 'Status',
    'status_paid': 'Plaćeno',
    'status_partial': 'Djelimično',
    'status_open': 'Otvoreno',
    'no_bills': 'Još nema dugovanja.',
    'recent_payments': 'Najnovije uplate',
    'pay_date': 'Datum',
    'pay_resident': 'Stanar',
    'pay_amount': 'Iznos',
    'pay_method': 'Način',
    'no_payments': 'Još nema uplata.',
    'recent_tickets': 'Najnoviji zahtjevi',
    'ticket_title': 'Naslov',
    'ticket_status': 'Status',
    'ticket_closed': 'Zatvoreno',
    'ticket_in_progress': 'U toku',
    'ticket_open': 'Otvoreno',
    'no_tickets': 'Još nema zahtjeva.',
    'carryover_amount': 'Prenos iz prethodnih mjeseci',
    'carryover_hint': 'Ukupan neplaćeni preostali iznos dugova prije ovog mjeseca',
    'recent_announcements': 'Najnovija obavještenja',
    'created_by': 'Kreirao',
    'unknown': 'Nepoznato',
    'expired': 'Isteklo',
    'no_announcements': 'Još nema obavještenja.'
  },
  'ru': {
    'page_title': 'Панель управления',
    'topbar_title': 'Главная панель администратора',
    'general_summary': 'Общий обзор',
    'general_summary_desc': 'Краткий обзор квартир, пользователей, задолженностей и заявок.',
    'total_apartments': 'Всего квартир',
    'users': 'Пользователи',
    'admin': 'Администратор',
    'resident': 'Жилец',
    'open_partial_debt': 'Открытый / частичный долг',
    'total_bill_records': 'Всего записей задолженностей',
    'total_paid': 'Всего оплачено',
    'expected_income_this_month': 'Ожидаемый доход в этом месяце',
    'expected_income_hint': 'Сумма всех задолженностей, созданных в этом месяце',
    'open_tickets': 'Открытые заявки',
    'view_all_tickets': 'Посмотреть все заявки →',
    'monthly_overview_title': 'Ежемесячный обзор (последние 12 месяцев)',
    'monthly_overview_desc': 'Общая сумма начислений и собранных оплат по каждому месяцу.',
    'year_total': 'Итого за год',
    'selected_period': 'Выбранный период',
    'billed': 'Начислено',
    'collected': 'Собрано',
    'delta': 'Разница',
    'table_month': 'Месяц',
    'table_billed': 'Начислено',
    'table_paid': 'Собрано',
    'table_delta': 'Разница',
    'not_enough_data': 'Пока недостаточно данных для формирования ежемесячного обзора.',
    'recent_bills': 'Последние начисления',
    'bill_apartment': 'Квартира',
    'bill_desc': 'Описание',
    'bill_amount': 'Сумма',
    'bill_status': 'Статус',
    'status_paid': 'Оплачено',
    'status_partial': 'Частично',
    'status_open': 'Открыто',
    'no_bills': 'Пока нет записей о начислениях.',
    'recent_payments': 'Последние платежи',
    'pay_date': 'Дата',
    'pay_resident': 'Жилец',
    'pay_amount': 'Сумма',
    'pay_method': 'Способ',
    'no_payments': 'Пока нет записей о платежах.',
    'recent_tickets': 'Последние заявки',
    'ticket_title': 'Заголовок',
    'ticket_status': 'Статус',
    'ticket_closed': 'Закрыто',
    'ticket_in_progress': 'В работе',
    'ticket_open': 'Открыто',
    'no_tickets': 'Пока нет созданных заявок.',
    'carryover_amount': 'Переходящий остаток (прошлые месяцы)',
    'carryover_hint': 'Сумма неоплаченного остатка по долгам до текущего месяца',
    'recent_announcements': 'Последние объявления',
    'created_by': 'Создал(а)',
    'unknown': 'Неизвестно',
    'expired': 'Срок истёк',
    'no_announcements': 'Пока нет объявлений.'
  }
} %}

{% macro tp(k) -%}
  {{ I18N_PAGE.get(LANG, I18N_PAGE['tr']).get(k, I18N_PAGE['tr'].get(k, k)) }}
{%- endmacro %}

{% set MONTHS = {
  'tr': {1:"Ocak",2:"Şubat",3:"Mart",4:"Nisan",5:"Mayıs",6:"Haziran",7:"Temmuz",8:"Ağustos",9:"Eylül",10:"Ekim",11:"Kasım",12:"Aralık"},
  'en': {1:"January",2:"February",3:"March",4:"April",5:"May",6:"June",7:"July",8:"August",9:"September",10:"October",11:"November",12:"December"},
  'me': {1:"Januar",2:"Februar",3:"Mart",4:"April",5:"Maj",6:"Jun",7:"Jul",8:"Avgust",9:"Septembar",10:"Oktobar",11:"Novembar",12:"Decembar"},
  'ru': {1:"Январь",2:"Февраль",3:"Март",4:"Апрель",5:"Май",6:"Июнь",7:"Июль",8:"Август",9:"Сентябрь",10:"Октябрь",11:"Ноябрь",12:"Декабрь"}
} %}

{% block title %}{{ tp('page_title') }}{% endblock %}

{% block topbar_title %}
  {{ tp('topbar_title') }}
  {% if session.active_site_name %}
    – {{ session.active_site_name }}
  {% elif current_site_name %}
    – {{ current_site_name }}
  {% endif %}
{% endblock %}

{% block content %}

<style>
/* ============================================================
   DASHBOARD - PROFESSIONAL STYLING
   ============================================================ */

.dashboard-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  padding: 16px;
}

@media (max-width: 1200px) {
  .dashboard-grid {
    grid-template-columns: 1fr;
  }
}

.card {
  background: #ffffff;
  border-radius: 10px;
  padding: 16px;
  border: 1px solid #e5e7eb;
  box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
  margin-top: 14px;
}

.card:first-child {
  margin-top: 0;
}

.card > h2 {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 6px;
  color: #0f172a;
  letter-spacing: -0.3px;
}

.card > p {
  font-size: 12px;
  color: #6b7280;
  margin-bottom: 12px;
  line-height: 1.5;
}

.stat-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 12px;
  margin-top: 12px;
}

.stat-card {
  background: #f9fafb;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 12px;
  transition: all 0.2s ease;
}

.stat-card:hover {
  border-color: #d1d5db;
  box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.05);
}

.stat-card__label {
  font-size: 11px;
  font-weight: 600;
  color: #6b7280;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 6px;
  display: block;
}

.stat-card__value {
  font-size: 20px;
  font-weight: 700;
  color: #0f172a;
  margin-bottom: 4px;
  line-height: 1.2;
}

.stat-card__hint {
  font-size: 11px;
  color: #6b7280;
  line-height: 1.4;
}

.month-filter-pill {
  border-radius: 999px;
  border: 1px solid #e5e7eb;
  padding: 6px 12px;
  font-size: 11px;
  font-weight: 500;
  background: #ffffff;
  color: #374151;
  cursor: pointer;
  white-space: nowrap;
  transition: all 0.2s ease;
  display: inline-block;
}

.month-filter-pill:hover {
  border-color: #d1d5db;
  background: #f9fafb;
}

.month-filter-pill.is-active-filter {
  background: #0f172a;
  color: #f9fafb;
  border-color: #0f172a;
  font-weight: 600;
}

.dash-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 12px;
  color: #374151;
}

.dash-table thead {
  background: #f9fafb;
  border-bottom: 1px solid #e5e7eb;
}

.dash-table th {
  text-align: left;
  padding: 8px 10px;
  font-weight: 600;
  color: #0f172a;
  white-space: nowrap;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

.dash-table th:last-child {
  text-align: right;
}

.dash-table tbody tr {
  border-bottom: 1px solid #f3f4f6;
  transition: background-color 0.15s ease;
}

.dash-table tbody tr:hover {
  background-color: #fafbfc;
}

.dash-table td {
  padding: 10px;
  color: #374151;
}

.dash-table td:last-child {
  text-align: right;
}

tr.is-active-month-row {
  background: #eff6ff;
}

.tag {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 600;
  white-space: nowrap;
  border: 1px solid;
}

.tag--success {
  background: #dcfce7;
  color: #166534;
  border-color: #bbf7d0;
}

.tag--warning {
  background: #fef3c7;
  color: #92400e;
  border-color: #fde68a;
}

.tag--danger {
  background: #fee2e2;
  color: #991b1b;
  border-color: #fecaca;
}

.card a {
  color: #2563eb;
  text-decoration: none;
  transition: color 0.2s ease;
}

.card a:hover {
  color: #1d4ed8;
  text-decoration: underline;
}

.scrollable-container {
  max-height: 440px;
  overflow-y: auto;
  border-radius: 6px;
}

.scrollable-container::-webkit-scrollbar {
  width: 6px;
}

.scrollable-container::-webkit-scrollbar-track {
  background: transparent;
}

.scrollable-container::-webkit-scrollbar-thumb {
  background: #d1d5db;
  border-radius: 3px;
}

.scrollable-container::-webkit-scrollbar-thumb:hover {
  background: #9ca3af;
}

.announcement-list {
  list-style: none;
  margin: 0;
  padding: 0;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.announcement-item {
  padding: 10px 12px;
  border-radius: 10px;
  background: #f9fafb;
  border: 1px solid #e5e7eb;
  transition: all 0.2s ease;
}

.announcement-item:hover {
  border-color: #d1d5db;
  box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.05);
}

.announcement-item.is-expired {
  opacity: 0.65;
}

.text-muted { color: #9ca3af; }
.text-success { color: #16a34a; }
.text-danger { color: #b91c1c; }
.delta-positive { color: #15803d; }
.delta-negative { color: #b91c1c; }
.delta-neutral { color: #4b5563; }

@media (max-width: 768px) {
  .dashboard-grid { padding: 12px; gap: 12px; }
  .card { padding: 12px; }
  .stat-grid { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); }
  .month-filter-pill { padding: 4px 8px; font-size: 10px; }
  .dash-table { font-size: 11px; }
  .dash-table th, .dash-table td { padding: 6px 4px; }
}
/* 400px altı ultra küçük ekran düzeltmesi */
@media (max-width: 380px) {

  body {
    overflow-x: hidden;
  }

  .dashboard-grid {
    padding: 2px;
    grid-template-columns: 0.8fr;
  }

  .card {
    padding: 10px;
    margin-top: 10px;
  }

  .stat-grid {
    grid-template-columns: 1fr;
  }

  .stat-card__value {
    font-size: 18px;
  }

  .stat-card__label {
    font-size: 10px;
  }

  .topbar,
  header {
    position: relative !important;
  }

  .page-content,
  main {
    padding-top: 8px !important;
  }
}

</style>

<div class="dashboard-grid">

  <!-- SOL SÜTUN -->
  <section>

    <!-- GENEL ÖZET KARTI -->
    <div class="card">
      <h2>
        {{ tp('general_summary') }}
        {% if today %}
          <span style="color: #6b7280; font-weight: 500;">
            — {{ MONTHS.get(LANG, MONTHS['tr'])[today.month] }} {{ today.year }}
          </span>
        {% endif %}
      </h2>
      <p>{{ tp('general_summary_desc') }}</p>

      <div class="stat-grid">
        <div class="stat-card">
          <div class="stat-card__label">{{ tp('total_apartments') }}</div>
          <div class="stat-card__value">{{ stats.total_apartments }}</div>
        </div>

        <div class="stat-card">
          <div class="stat-card__label">{{ tp('users') }}</div>
          <div class="stat-card__value">{{ stats.total_users }}</div>
          <div class="stat-card__hint">
            {{ tp('admin') }}: {{ stats.admin_users }} • {{ tp('resident') }}: {{ stats.resident_users }}
          </div>
        </div>

<div class="stat-card">
          <div class="stat-card__label">{{ tp('open_partial_debt') }}</div>
          <div class="stat-card__value" style="{% if stats.total_open_amount < 0 %}color: #059669;{% elif stats.total_open_amount > 0 %}color: #dc2626;{% else %}color: #0f172a;{% endif %}">
            ₺ {{ "%.2f"|format(stats.total_open_amount) }}
          </div>
          <div class="stat-card__hint">
            {% if stats.total_open_amount < 0 %}
              Fazla ödeme (Kredit)
            {% elif stats.total_open_amount > 0 %}
              Toplam açık borç
            {% else %}
              Tümü ödenmiş
            {% endif %}
            • {{ tp('total_bill_records') }}: {{ stats.total_bills }}
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-card__label">{{ tp('carryover_amount') }}</div>
          <div class="stat-card__value">₺ {{ "%.2f"|format(stats.carryover_amount) }}</div>
          <div class="stat-card__hint">{{ tp('carryover_hint') }}</div>
        </div>

        <div class="stat-card">
          <div class="stat-card__label">{{ tp('total_paid') }}</div>
          <div class="stat-card__value">₺ {{ "%.2f"|format(stats.total_paid_amount) }}</div>
        </div>

        <div class="stat-card">
          <div class="stat-card__label">{{ tp('expected_income_this_month') }}</div>
          <div class="stat-card__value">₺ {{ "%.2f"|format(stats.expected_income_this_month) }}</div>
          <div class="stat-card__hint">{{ tp('expected_income_hint') }}</div>
        </div>

        <div class="stat-card">
          <div class="stat-card__label">{{ tp('open_tickets') }}</div>
          <div class="stat-card__value">{{ stats.open_tickets }}</div>
          <div class="stat-card__hint">
            <a href="{{ url_for('admin.manage_tickets') }}">{{ tp('view_all_tickets') }}</a>
          </div>
        </div>
      </div>
    </div>

    <!-- AYLIK ÖZET KARTI -->
    <div class="card" data-monthly-card>
      <h2>{{ tp('monthly_overview_title') }}</h2>
      <p>{{ tp('monthly_overview_desc') }}</p>

      {% if monthly_overview and today %}
        {% set year_ns = namespace(billed=0, paid=0) %}
        {% for m in monthly_overview %}
          {% if m.year == today.year %}
            {% set year_ns.billed = year_ns.billed + m.total_billed %}
            {% set year_ns.paid = year_ns.paid + m.total_paid %}
          {% endif %}
        {% endfor %}
        {% set year_delta = year_ns.paid - year_ns.billed %}

        <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px;">
          <button
            type="button"
            class="month-filter-pill"
            data-filter-btn
            data-type="year"
            data-label="{{ today.year }} {{ tp('year_total') }}"
            data-billed="{{ '%.2f'|format(year_ns.billed) }}"
            data-paid="{{ '%.2f'|format(year_ns.paid) }}"
            data-delta="{{ '%.2f'|format(year_delta) }}"
          >
            {{ today.year }} {{ tp('year_total') }}
          </button>

          {% for m in monthly_overview %}
            {% set is_current = (m.year == today.year and m.month == today.month) %}
            {% set month_label = MONTHS.get(LANG, MONTHS['tr'])[m.month] ~ ' ' ~ m.year %}
            <button
              type="button"
              class="month-filter-pill{% if is_current %} is-active-filter{% endif %}"
              data-filter-btn
              data-type="month"
              data-year="{{ m.year }}"
              data-month="{{ m.month }}"
              data-label="{{ month_label }}"
              data-billed="{{ '%.2f'|format(m.total_billed) }}"
              data-paid="{{ '%.2f'|format(m.total_paid) }}"
              data-delta="{{ '%.2f'|format(m.delta) }}"
              {% if is_current %}data-default="1"{% endif %}
            >
              {{ month_label }}
            </button>
          {% endfor %}
        </div>

        <div style="padding: 8px 10px; border-radius: 8px; background: #f9fafb; margin-bottom: 12px; font-size: 11px; border: 1px solid #e5e7eb;">
          <div style="font-weight: 700; margin-bottom: 4px; color: #0f172a;" data-summary-label>{{ tp('selected_period') }}</div>
          <div>
            {{ tp('billed') }}: <span data-summary-billed>₺ 0,00</span> · 
            {{ tp('collected') }}: <span data-summary-paid>₺ 0,00</span> · 
            {{ tp('delta') }}: <span data-summary-delta>₺ 0,00</span>
          </div>
        </div>

        <div class="scrollable-container">
          <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
            <thead>
              <tr style="background: #f9fafb; border-bottom: 1px solid #e5e7eb;">
                <th style="text-align: left; padding: 6px 4px; white-space: nowrap;">{{ tp('table_month') }}</th>
                <th style="text-align: right; padding: 6px 4px; white-space: nowrap;">{{ tp('table_billed') }}</th>
                <th style="text-align: right; padding: 6px 4px; white-space: nowrap;">{{ tp('table_paid') }}</th>
                <th style="text-align: right; padding: 6px 4px; white-space: nowrap;">{{ tp('table_delta') }}</th>
              </tr>
            </thead>
            <tbody>
              {% for m in monthly_overview|reverse %}
                {% set row_label = MONTHS.get(LANG, MONTHS['tr'])[m.month] ~ ' ' ~ m.year %}
                <tr style="border-bottom: 1px solid #f3f4f6;" data-month-row data-year="{{ m.year }}" data-month="{{ m.month }}">
                  <td style="padding: 6px 4px; white-space: nowrap;">{{ row_label }}</td>
                  <td style="padding: 6px 4px; text-align: right; white-space: nowrap;">₺ {{ "%.2f"|format(m.total_billed) }}</td>
                  <td style="padding: 6px 4px; text-align: right; white-space: nowrap;">₺ {{ "%.2f"|format(m.total_paid) }}</td>
                  <td style="padding: 6px 4px; text-align: right; white-space: nowrap; {% if m.delta < 0 %}color: #b91c1c;{% elif m.delta > 0 %}color: #15803d;{% else %}color: #4b5563;{% endif %}">
                    {% if m.delta >= 0 %}+{% endif %}₺ {{ "%.2f"|format(m.delta) }}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <script>
          document.addEventListener('DOMContentLoaded', function () {
            const card = document.querySelector('[data-monthly-card]');
            if (!card) return;

            const buttons = card.querySelectorAll('[data-filter-btn]');
            const rows = card.querySelectorAll('[data-month-row]');
            const summaryLabel = card.querySelector('[data-summary-label]');
            const summaryBilled = card.querySelector('[data-summary-billed]');
            const summaryPaid = card.querySelector('[data-summary-paid]');
            const summaryDelta = card.querySelector('[data-summary-delta]');

            function clearActiveButtons() {
              buttons.forEach(btn => btn.classList.remove('is-active-filter'));
            }

            function clearRowHighlight() {
              rows.forEach(row => row.classList.remove('is-active-month-row'));
            }

            function setSummary(label, billed, paid, delta) {
              summaryLabel.textContent = label;
              summaryBilled.textContent = '₺ ' + billed;
              summaryPaid.textContent = '₺ ' + paid;

              const deltaNum = parseFloat(delta);
              const prefix = deltaNum >= 0 ? '+' : '';
              summaryDelta.textContent = prefix + '₺ ' + delta;

              if (deltaNum > 0) {
                summaryDelta.style.color = '#15803d';
              } else if (deltaNum < 0) {
                summaryDelta.style.color = '#b91c1c';
              } else {
                summaryDelta.style.color = '#4b5563';
              }
            }

            function activateMonth(year, month, label, billed, paid, delta) {
              setSummary(label, billed, paid, delta);
              clearRowHighlight();
              rows.forEach(row => {
                if (row.dataset.year === String(year) && row.dataset.month === String(month)) {
                  row.classList.add('is-active-month-row');
                }
              });
            }

            function activateYear(label, billed, paid, delta) {
              setSummary(label, billed, paid, delta);
              clearRowHighlight();
            }

            buttons.forEach(btn => {
              btn.addEventListener('click', function () {
                clearActiveButtons();
                this.classList.add('is-active-filter');

                const type = this.dataset.type;
                if (type === 'year') {
                  activateYear(this.dataset.label, this.dataset.billed, this.dataset.paid, this.dataset.delta);
                } else {
                  activateMonth(this.dataset.year, this.dataset.month, this.dataset.label, this.dataset.billed, this.dataset.paid, this.dataset.delta);
                }
              });
            });

            const defaultBtn = card.querySelector('[data-filter-btn][data-default="1"]') || card.querySelector('[data-filter-btn]');
            if (defaultBtn) defaultBtn.click();
          });
        </script>
      {% else %}
        <p>{{ tp('not_enough_data') }}</p>
      {% endif %}
    </div>

  </section>

  <!-- SAĞ SÜTUN: KISA LİSTELER -->
  <section>

    <!-- SON BORÇLAR -->
    <div class="card">
      <h2>{{ tp('recent_bills') }}</h2>

      {% if recent_bills %}
        <div class="scrollable-container">
          <table class="dash-table">
            <thead>
              <tr>
                <th>{{ tp('bill_apartment') }}</th>
                <th>{{ tp('bill_desc') }}</th>
                <th>{{ tp('bill_amount') }}</th>
                <th>{{ tp('bill_status') }}</th>
              </tr>
            </thead>
            <tbody>
              {% for bill, apt in recent_bills %}
                <tr>
                  <td>
                    {% if apt %}
                      {{ apt.block }} Blok • {{ apt.floor }}/{{ apt.number }}
                    {% else %}
                      <span class="text-muted">-</span>
                    {% endif %}
                  </td>
                  <td>
                    <span style="display: inline-block; max-width: 180px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                      {{ bill.description }}
                    </span>
                  </td>
                  <td>₺ {{ "%.2f"|format(bill.amount) }}</td>
                  <td>
                    {% if bill.status == 'paid' %}
                      <span class="tag tag--success">{{ tp('status_paid') }}</span>
                    {% elif bill.status == 'partial' %}
                      <span class="tag tag--warning">{{ tp('status_partial') }}</span>
                    {% else %}
                      <span class="tag tag--danger">{{ tp('status_open') }}</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p style="font-size: 13px; color: #6b7280;">{{ tp('no_bills') }}</p>
      {% endif %}
    </div>

    <!-- SON ÖDEMELER -->
    <div class="card">
      <h2>{{ tp('recent_payments') }}</h2>

      {% if recent_payments %}
        <div class="scrollable-container">
          <table class="dash-table">
            <thead>
              <tr>
                <th>{{ tp('pay_date') }}</th>
                <th>{{ tp('bill_apartment') }}</th>
                <th>{{ tp('pay_resident') }}</th>
                <th>{{ tp('pay_amount') }}</th>
                <th>{{ tp('pay_method') }}</th>
              </tr>
            </thead>
            <tbody>
              {% for payment, apt, u in recent_payments %}
                <tr>
                  <td>
                    {% if payment.payment_date %}
                      {{ payment.payment_date.strftime('%d.%m.%Y') }}
                    {% else %}
                      <span class="text-muted">-</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if apt %}
                      {{ apt.block }} Blok • {{ apt.floor }}/{{ apt.number }}
                    {% else %}
                      <span class="text-muted">-</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if u %}
                      {{ u.name }}
                    {% else %}
                      <span class="text-muted">-</span>
                    {% endif %}
                  </td>
                  <td class="text-success">₺ {{ "%.2f"|format(payment.amount) }}</td>
                  <td>
                    {% if payment.method %}
                      {{ payment.method|capitalize }}
                    {% else %}
                      <span class="text-muted">-</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p style="font-size: 13px; color: #6b7280;">{{ tp('no_payments') }}</p>
      {% endif %}
    </div>

    <!-- SON TALEPLER -->
    <div class="card">
      <h2>{{ tp('recent_tickets') }}</h2>

      {% if recent_tickets %}
        <div style="max-height: 220px; overflow-y: auto; border-radius: 6px;">
          <table class="dash-table">
            <thead>
              <tr>
                <th>{{ tp('pay_date') }}</th>
                <th>{{ tp('bill_apartment') }}</th>
                <th>{{ tp('pay_resident') }}</th>
                <th>{{ tp('ticket_title') }}</th>
                <th>{{ tp('ticket_status') }}</th>
              </tr>
            </thead>
            <tbody>
              {% for t, apt, u in recent_tickets %}
                <tr>
                  <td>
                    {% if t.created_at %}
                      {{ t.created_at.strftime('%d.%m.%Y %H:%M') }}
                    {% else %}
                      <span class="text-muted">-</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if apt %}
                      {{ apt.block }} Blok • {{ apt.floor }}/{{ apt.number }}
                    {% else %}
                      <span class="text-muted">-</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if u %}
                      {{ u.name }}
                    {% else %}
                      <span class="text-muted">-</span>
                    {% endif %}
                  </td>
                  <td>
                    <span style="display: inline-block; max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                      {{ t.title }}
                    </span>
                  </td>
                  <td>
                    {% if t.status == 'closed' %}
                      <span class="tag tag--success">{{ tp('ticket_closed') }}</span>
                    {% elif t.status == 'in_progress' %}
                      <span class="tag tag--warning">{{ tp('ticket_in_progress') }}</span>
                    {% else %}
                      <span class="tag tag--danger">{{ tp('ticket_open') }}</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p style="font-size: 13px; color: #6b7280;">{{ tp('no_tickets') }}</p>
      {% endif %}
    </div>

    <!-- SON DUYURULAR -->
    <div class="card">
      <h2>{{ tp('recent_announcements') }}</h2>

      {% if recent_announcements %}
        <ul class="announcement-list">
          {% for ann, u in recent_announcements %}
            {% set is_expired = ann.created_at and (today - ann.created_at.date()).days >= 29 %}
            <li class="announcement-item{% if is_expired %} is-expired{% endif %}">
              <div style="display: flex; justify-content: space-between; gap: 8px; margin-bottom: 4px;">
                <div style="font-size: 13px; font-weight: 600; {% if is_expired %}text-decoration: line-through;{% endif %}">
                  {{ ann.title }}
                </div>
                <div style="font-size: 11px; color: #6b7280; white-space: nowrap;">
                  {% if ann.created_at %}
                    {{ ann.created_at.strftime('%d.%m.%Y %H:%M') }}
                  {% endif %}
                </div>
              </div>
              <div style="font-size: 12px; color: #4b5563; margin-bottom: 6px; {% if is_expired %}text-decoration: line-through; color: #6b7280;{% endif %}">
                {{ ann.content }}
              </div>
              <div style="font-size: 11px; color: #6b7280;">
                {{ tp('created_by') }}:
                {% if u %}
                  {{ u.name }}
                {% else %}
                  <span class="text-muted">{{ tp('unknown') }}</span>
                {% endif %}
                {% if is_expired %}
                  · <span style="font-style: italic;">({{ tp('expired') }})</span>
                {% endif %}
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p style="font-size: 13px; color: #6b7280;">{{ tp('no_announcements') }}</p>
      {% endif %}
    </div>

  </section>

</div>

{% endblock %}